WS.ImageDisplayWindow=Core.extend(Echo.WindowPane,{$construct:function(a){this._r=WS.getResources();Echo.WindowPane.call(this,{styleName:"Default",resourceTimeout:0,modal:true,openAnimationTime:0,closeAnimationTime:0,closable:true,maximizeEnabled:true,title:this._r.m["ImageDisplayWindow.Title"],icon:this._r.i["ImageDisplayWindow.Icon"],contentWidth:"75%",contentHeight:"75%",events:{close:Core.method(this,function(b){this.parent.remove(this);})},children:[new Echo.SplitPane({styleName:"ControlPane.SplitBottom",children:[new Echo.SplitPane({orientation:Echo.SplitPane.ORIENTATION_HORIZONTAL_RIGHT_LEFT,separatorPosition:"10em",children:[new Echo.Row({styleName:"ControlPane",children:[new Echo.Button({styleName:"ControlPane",icon:this._r.i["ImageDisplayWindow.Download"],text:this._r.m["ImageDisplayWindow.Download"],events:{action:Core.method(this,function(b){this.fireEvent({source:this,type:"download"});})}})]}),new Echo.Row({styleName:"ControlPane",children:[new Echo.Button({styleName:"ControlPane",icon:this._r.i["ImageDisplayWindow.ZoomOut"],events:{action:Core.method(this,this._processOut)}}),this._zoomLabel=new Echo.Label({layoutData:{width:"4em",alignment:"right",insets:"0 1ex"},text:"100%"}),new Echo.Button({styleName:"ControlPane",icon:this._r.i["ImageDisplayWindow.ZoomIn"],events:{action:Core.method(this,this._processIn)}}),new Echo.Button({styleName:"ControlPane",icon:this._r.i["ImageDisplayWindow.FitToWindow"],text:this._r.m["ImageDisplayWindow.FitToWindow"],events:{action:Core.method(this,this._processFit)}}),new Echo.Button({styleName:"ControlPane",icon:this._r.i["ImageDisplayWindow.ActualSize"],text:this._r.m["ImageDisplayWindow.ActualSize"],events:{action:Core.method(this,this._processActual)}})]})]}),new Echo.ContentPane({background:"#5f5f5f",children:[this._imageDisplay=new WS.ImageDisplay({image:a,fit:true,events:{property:Core.method(this,this._updateStatus)}})]})]})]});
},_processActual:function(){this._imageDisplay.set("fit",false);this._imageDisplay.set("zoom",1);},_processFit:function(){this._imageDisplay.set("fit",true);},_processIn:function(){this._imageDisplay.zoom(false);},_processOut:function(){this._imageDisplay.zoom(true);},_updateStatus:function(){Core.Web.Scheduler.run(Core.method(this,function(){var a=parseFloat(this._imageDisplay.get("zoom")||1)||1;this._zoomLabel.set("text",Math.round(a*100)+"%");}));}});WS.ImageDisplay=Core.extend(Echo.Component,{$static:{ZOOM_VALUES:[0.1,0.15,0.2,0.25,0.3,0.4,0.5,0.6,0.75,1,1.5,2,2.5,3,4,5,6,8,10]},$load:function(){Echo.ComponentFactory.registerType("WS.ImageDisplay",this);},componentType:"WS.ImageDisplay",zoom:function(a){this.set("fit",false);var c=parseFloat(this.get("zoom")||1)||1,b;if(a){for(b=WS.ImageDisplay.ZOOM_VALUES.length-1;b>=0;--b){if(c>WS.ImageDisplay.ZOOM_VALUES[b]){this.set("zoom",WS.ImageDisplay.ZOOM_VALUES[b]);return;}}this.set("zoom",WS.ImageDisplay.ZOOM_VALUES[0]);}else{for(b=0;b<WS.ImageDisplay.ZOOM_VALUES.length;
++b){if(c<WS.ImageDisplay.ZOOM_VALUES[b]){this.set("zoom",WS.ImageDisplay.ZOOM_VALUES[b]);return;}}this.set("zoom",WS.ImageDisplay.ZOOM_VALUES[WS.ImageDisplay.ZOOM_VALUES.length-1]);}}});WS.ImageDisplay.Sync=Core.extend(Echo.Render.ComponentSync,{$load:function(){Echo.Render.registerPeer("WS.ImageDisplay",this);},_imagePosition:null,_imageData:null,_regionBounds:null,_displayed:false,_createOverlay:function(){if(this._overlayDiv){return;}Core.Web.dragInProgress=true;this._overlayDiv=document.createElement("div");this._overlayDiv.style.cssText="position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;z-index:31000";Echo.Sync.FillImage.render(this.client.getResourceUrl("Echo","resource/Transparent.gif"),this._overlayDiv);document.body.appendChild(this._overlayDiv);this.client.forceRedraw();},_fit:function(){var a=this._imageData.width/this._regionBounds.width,b=this._imageData.height/this._regionBounds.height;var c=1;if(a>1||b>1){var d;if(a>b){c=1/a;}else{c=1/b;}}this.component.set("zoom",c);
},_processImageReady:function(){if(!this._img){return;}var b=parseInt(this._img.width,10);var a=parseInt(this._img.height,10);this._imageData={width:b,height:a,ar:b/a};this._imagePosition={x:0,y:0};if(this._displayed){this._img.style.visibility="visible";this._fit();this._update();}},_processMouseDown:function(a){Core.Web.DOM.preventEventDefault(a);this._createOverlay();this._imageOrigin={x:parseInt(this._img.style.left,10),y:parseInt(this._img.style.top,10)};this._dragOrigin={x:a.clientX,y:a.clientY};Core.Web.Event.add(this._overlayDiv,"mousemove",Core.method(this,this._processMouseMove),false);Core.Web.Event.add(this._overlayDiv,"mouseup",Core.method(this,this._processMouseUp),false);},_processMouseMove:function(a){var b={x:a.clientX-this._dragOrigin.x,y:a.clientY-this._dragOrigin.y};this._img.style.left=(this._imageOrigin.x+b.x)+"px";this._img.style.top=(this._imageOrigin.y+b.y)+"px";},_processMouseUp:function(d){this._removeOverlay();var c=parseFloat(this.component.get("zoom"),10)||1;
var a=Math.round(c*this._imageData.width);var b=Math.round(c*this._imageData.height);var g=parseInt(this._img.style.left,10);var f=parseInt(this._img.style.top,10);this._imagePosition.x=g/(this._regionBounds.width-a);this._imagePosition.y=f/(this._regionBounds.height-b);this._update();},_processWheel:function(b){var a;if(b.wheelDelta){a=b.wheelDelta/-120;}else{if(b.detail){a=b.detail/3;}else{return;}}this.component.zoom(a>0);Core.Web.DOM.preventEventDefault(b);return true;},_removeOverlay:function(){if(!this._overlayDiv){return;}Core.Web.dragInProgress=false;Core.Web.Event.removeAll(this._overlayDiv);document.body.removeChild(this._overlayDiv);this._overlayDiv=null;this.client.forceRedraw();},renderAdd:function(b,a){this._div=document.createElement("div");this._div.style.cssText="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;cursor:move;";this._img=document.createElement("img");this._img.style.cssText="visibility:hidden;position:absolute;top:0;left:0;";this._img.src=this.component.render("image");
if(Core.Web.Env.ENGINE_MSHTML){this._img.style.msInterpolationMode="bicubic";}this._div.appendChild(this._img);a.appendChild(this._div);Core.Web.Image.monitor(this._div,Core.method(this,this._processImageReady));Core.Web.Event.add(this._div,"mousedown",Core.method(this,this._processMouseDown),false);Core.Web.Event.add(this._div,Core.Web.Env.ENGINE_GECKO?"DOMMouseScroll":"mousewheel",Core.method(this,this._processWheel),true);},renderDisplay:function(){Core.Web.VirtualPosition.redraw(this._div);this._regionBounds=new Core.Web.Measure.Bounds(this._div);this._displayed=true;if(!this._imageData&&this._img.complete){this._processImageReady();}this._update();},renderDispose:function(a){this._removeOverlay();this._div=null;this._img=null;},renderUpdate:function(c){if(c.isUpdatedPropertySetIn({fit:true,zoom:true})){return;}this._displayed=false;var a=this._div;var b=a.parentNode;Echo.Render.renderComponentDispose(c,c.parent);b.removeChild(a);this.renderAdd(c,b);return true;},_update:function(){if(!this._imageData){return;
}if(this.component.get("fit")){this._fit();}var c=parseFloat(this.component.get("zoom"),10);var a=Math.round(c*this._imageData.width);var b=Math.round(c*this._imageData.height);if(this._img.width!=a){this._img.width=a;}if(this._img.height!=b){this._img.height=b;}if(a<=this._regionBounds.width){this._imagePosition.x=0.5;}else{this._imagePosition.x=Math.max(0,Math.min(1,this._imagePosition.x));}if(b<=this._regionBounds.height){this._imagePosition.y=0.5;}else{this._imagePosition.y=Math.max(0,Math.min(1,this._imagePosition.y));}var e=(this._regionBounds.width-a)*this._imagePosition.x;var d=(this._regionBounds.height-b)*this._imagePosition.y;this._img.style.left=Math.floor(e)+"px";this._img.style.top=Math.floor(d)+"px";}});