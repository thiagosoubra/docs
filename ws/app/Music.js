WS.Music=Core.extend(WS.WorkspaceModule,{$static:{TrackData:Core.extend({$construct:function(e,d,c,a,b){this.id=e;this.duration=d;this.name=c;this.artist=a;this.album=b;}}),SUPPORTED_FORMATS:{"mp3":true,"mpeg":true,"mpeg3":true,"aac":true,"x-aac":true,"x-m4a":true,"x-m4b":true,"mp4":true},MOVIE_STAR_FORMATS:{"aac":true,"x-aac":true,"x-m4a":true,"x-m4b":true,"mp4":true}},_syncAudio:null,_shuffleOrder:null,sound:null,tracks:null,trackIndex:null,_repeat:true,_shuffle:false,_volume:100,_updateEnabled:false,_playUpdateRunnable:null,_workspace:null,_activeDisplay:null,_trackDisplay:null,_processOpenRef:null,_xfileClient:null,$construct:function(){this._updateEnabled=WS.user.owner||WS.user.permissions.musicUpdate;this._r=WS.getResources();this._playUpdateRunnable=new Core.Web.Scheduler.MethodRunnable(Core.method(this,this._updateState),1000,true);this._processActionRef=Core.method(this,this._processAction);this._processOpenRef=Core.method(this,this._processOpen);this.fileContributions=[new Extras.OptionModel("downloadtracks",this._r.m["Menu.DownloadTracks"],this._r.i["Menu.DownloadTracks"]),new Extras.OptionModel("uploadtracks",this._r.m["Menu.UploadTracks"],this._r.i["Menu.UploadTracks"])];
this.viewContributions=[new Extras.OptionModel("refresh",this._r.m["Menu.Refresh"],this._r.i["Menu.Refresh"])];WS.WorkspaceModule.call(this,{events:{init:Core.method(this,function(a){this._syncAudio=new WS.Synchronize.Audio(this.application.server);this._xfileClient=new WS.Music.XFileClient(this,this._syncAudio);this._displayTracks();})},children:[new Echo.SplitPane({autoPositioned:true,orientation:Echo.SplitPane.ORIENTATION_VERTICAL_TOP_BOTTOM,children:[new Echo.Column({layoutData:{background:"#4f5f4f"},insets:"1.5em",cellSpacing:10,foreground:"#d8e8cd",children:[new Echo.Grid({insets:"0 5",size:3,width:"100%",columnWidth:["25%","50%","25%"],children:[this._completedTimeLabel=new Echo.Label({layoutData:{alignment:"right"},text:"\u00a0"}),this._trackProgress=new WS.Slider({border:{top:"1px solid #4f5f4f",left:"1px solid #4f5f4f",right:"1px solid #cfdfcf",bottom:"1px solid #cfdfcf"},background:"#afbfaf",valueColor:"#dfefdf",valueBorder:{left:"1px solid #efffef",top:"1px solid #efffef",bottom:"1px solid #7f8f7f",right:"1px solid #7f8f7f"},events:{action:Core.method(this,this._processSetTrackPosition)}}),this._remainingTimeLabel=new Echo.Label({text:"\u00a0"})]}),this._trackDescription=new WS.TrackDescription({layoutData:{insets:"0 5em"}})]}),new Echo.SplitPane({autoPositioned:true,orientation:Echo.SplitPane.ORIENTATION_VERTICAL_TOP_BOTTOM,children:[new Echo.Grid({size:4,width:"100%",children:[new Echo.Button({actionCommand:"previous",alignment:"center",insets:0,styleName:"Music.Control",icon:this._r.i["Music.PreviousTrack"],events:{action:Core.method(this,this._processTrackNavigate)}}),this._playButton=new Echo.Button({alignment:"center",insets:0,styleName:"Music.Control",icon:this._r.i["Music.Play"],events:{action:Core.method(this,this._processPlay)}}),new Echo.Button({actionCommand:"next",alignment:"center",insets:0,styleName:"Music.Control",icon:this._r.i["Music.NextTrack"],events:{action:Core.method(this,this._processTrackNavigate)}}),new Echo.Button({alignment:"center",insets:0,styleName:"Music.Control",icon:this._r.i["Music.Stop"],events:{action:Core.method(this,this._processStop)}})]}),new Extras.ContextMenu({styleName:"Default",stateModel:new WS.FileBrowser.ContextMenuModel(this),model:new Extras.MenuModel(null,null,null,[new Extras.OptionModel("downloadtracks",this._r.m["Menu.DownloadTracks"],this._r.i["Menu.DownloadTracks"]),new Extras.OptionModel("uploadtracks",this._r.m["Menu.UploadTracks"],this._r.i["Menu.UploadTracks"]),new Extras.SeparatorModel(),new Extras.OptionModel("refresh",this._r.m["Menu.Refresh"],this._r.i["Menu.Refresh"])]),children:[this._contentArea=new Echo.ContentPane({})],events:{action:Core.method(this,function(a){this.doOperation(a.modelId);
})}})]})]})]});},activate:function(b){this._workspace=b;b.xfile.setClient(this._xfileClient);var e;b.sidePane.add(new Echo.SplitPane({autoPositioned:true,orientation:Echo.SplitPane.ORIENTATION_VERTICAL_BOTTOM_TOP,background:"#7f7f7f",foreground:"#efefef",children:[new Echo.Column({font:{size:"8pt"},children:[new Echo.Column({insets:"1em",background:"#1f1f1f",children:[new Echo.Row({children:[new Echo.Column({layoutData:{width:"80%"},children:[this._volumeLabel=new Echo.Label({text:this._r.m["Music.VolumePrompt"]}),this._volumeSlider=new WS.Slider({minimumInset:"1.5em",maximumInset:"1.5em",border:{top:"1px solid #0f0f0f",left:"1px solid #0f0f0f",right:"1px solid #3f3f3f",bottom:"1px solid #3f3f3f"},background:"#1f1f1f",valueColor:"#7f7f7f",events:{action:Core.method(this,function(f){this._setVolume(f.value);})}})]}),this._volumeLabel=new Echo.Label({layoutData:{width:"20%",alignment:"right"},font:{typeface:WS.Style.ROBOTO_LIGHT,size:"20pt"}})]})]}),new Echo.Row({children:[new Echo.CheckBox({styleName:"Music.SidePane",layoutData:{width:"50%"},stateIcon:this._r.i["Music.Shuffle.Off"],selectedStateIcon:this._r.i["Music.Shuffle.On"],selected:this._shuffle,events:{action:Core.method(this,function(f){this._processShuffle(f.source.get("selected"));
})}}),new Echo.CheckBox({styleName:"Music.SidePane",layoutData:{width:"50%"},stateIcon:this._r.i["Music.Repeat.Off"],selectedStateIcon:this._r.i["Music.Repeat.On"],selected:this._repeat,events:{action:Core.method(this,function(f){this._repeat=f.source.get("selected");})}})]})]}),e=new Echo.Column({insets:"10 3 0 10",children:[new Echo.Grid({width:"100%",columnWidth:["50%","50%"],children:[new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Music.CategoryArtists"],text:this._r.m["Music.CategoryArtists"],events:{action:Core.method(this,this._displayArtists)}})]}),new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Music.CategoryAlbums"],text:this._r.m["Music.CategoryAlbums"],events:{action:Core.method(this,this._displayAlbums)}})]}),new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Music.CategoryTracks"],text:this._r.m["Music.CategoryTracks"],events:{action:Core.method(this,this._displayTracks)}})]}),new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Music.CategoryPlaylists"],text:this._r.m["Music.CategoryPlaylists"],events:{action:Core.method(this,this._displayPlaylists)}})]})]})]})]}));
if(WS.mediaIndices.length>1){var a=[];var d=0;for(var c=0;c<WS.mediaIndices.length;++c){a[c]=WS.mediaIndices[c].displayName;if(this._syncAudio.mediaIndex==WS.mediaIndices[c].name){d=c;}}e.add(new Echo.Row({cellSpacing:"1ex",children:[new Echo.Label({text:this._r.m["StorageBase.Prompt"]}),new Echo.SelectField({items:a,selection:d,events:{action:Core.method(this,function(g){var f=WS.mediaIndices[g.source.get("selection")||0].name;this._syncAudio.mediaIndex=f;WS.pref.mediaIndex=f;WS.savePrefs();this._doRefresh();})}})]}),0);}this._setVolume(this._volume);},_calculateSoundManagerVolume:function(){return this._volume*this._volume/100;},_displayAlbums:function(){this._setActiveDisplay(new WS.Music.AlbumDisplay(this._syncAudio));},_displayArtists:function(){this._setActiveDisplay(new WS.Music.ArtistDisplay(this._syncAudio));},_displayErrorNoFlash:function(){var a=new WS.Dialog(this._r.m["Media.NoFlashDialog.Title"],null,this._r.m["Media.NoFlashDialog.Message"],this._r.i["Dialog.Error"],[{resourceKey:"Media.NoFlashDialog.DownloadFlash",actionCommand:"download"},{resourceKey:"Generic.Cancel",actionCommand:"cancel"}]);
a.addListener("action",Core.method(this,function(b){if(b.actionCommand==="download"){window.open("http://get.adobe.com/flashplayer/");}}));this._contentArea.add(a);},_displayErrorMediaLoad:function(){var a=new WS.Dialog(this._r.m["Media.LoadErrorDialog.Title"],null,this._r.m["Media.LoadErrorDialog.Message"],this._r.i["Dialog.Error"],WS.Dialog.CONTROLS_OK);this._contentArea.add(a);},_displayPlaylists:function(){this._setActiveDisplay(new WS.Music.PlaylistDisplay(this._syncAudio));},_displayTracks:function(a){this._trackDisplay=new WS.Music.TrackDisplay(this._syncAudio,a);this._setActiveDisplay(this._trackDisplay);},_doDownloadTracks:function(){var a=this._activeDisplay.getSelectionQuery();if(!a){return;}top.location=this._syncAudio.getDownloadUrl(a);},doOperation:function(a){switch(a){case"downloadtracks":this._doDownloadTracks();break;case"uploadtracks":if(XFile.SUPPORT){if(this._workspace){this._workspace.xfile.choose(false);}}else{this.application.client.exec(WS.MODULE_UPLOAD,Core.method(this,this._doUploadTracks));
}break;case"refresh":this._doRefresh();break;}},_doRefresh:function(){this._activeDisplay.refresh();},_doUploadTracks:function(){var a=WS.pref.multipleUpload;var d=this._syncAudio.storageBase;var c=this._syncAudio.getUploadUrl(a);var b=new WS.Upload.Dialog({receiver:c,title:this._r.m["Upload.WindowTitle"],prompt:this._r.m["Upload.Prompt"],multiple:a,fileDescription:this._r.m["Upload.Description"]});b.addListener("action",Core.method(this,function(f){this._syncAudio.uploadStore(Core.method(this,function(e){if(e=="error"){this.application.displayError();}else{if(e=="ok"){this._doRefresh();}}}),d,f.fileId);}));this.application.content.add(b);},isOptionEnabled:function(a){switch(a){case"downloadtracks":return this._activeDisplay&&this._activeDisplay.getSelectionQuery()!=null;case"uploadtracks":return this._updateEnabled;default:return true;}},_loadShuffleOrder:function(){var e,c,b,a,d;a=this._trackDisplay.getTrackCount();d=[a];for(c=0;c<a;++c){d[c]=c;}for(c=a-1;c>0;--c){b=Math.floor(Math.random()*c);
e=d[c];d[c]=d[b];d[b]=e;}this._shuffleOrder=d;},_loadTrack:function(a){this.currentTrack=a;this._trackDescription.set("track",a);this._updateState();},onUploadStored:function(){this._doRefresh();},_playTrack:function(c){this.trackIndex=c;var a=this._trackDisplay.getTrack(c);if(!a){var b=Core.method(this,function(){this._playTrack(c||0);});this._trackDisplay.fetchTrack(b,c||0);return;}this._trackDisplay.setPlayingTrack(c,false);this._processStop();this._loadTrack(a);this._processPlay();},_playTrackNext:function(d){if(d){if(this.sound&&!this.sound.paused&&(this.sound.position>5000)){this.sound.setPosition(0);return;}}var b=this._trackDisplay.getTrackCount();var c;if(this._shuffle){var a;if(!this._shuffleOrder||this._shuffleOrder.length!=b){this._loadShuffleOrder();a=0;}else{a=this._shuffleIndex+(d?-1:1);if(this._repeat){if(a<0){a=b-1;}else{if(a>=b){a=0;}}}else{if(a<0){a=0;}else{if(a>=b){return;}}}}this._shuffleIndex=a;this.trackIndex=this._shuffleOrder[a];this._playTrack(this.trackIndex);
}else{c=this.trackIndex+(d?-1:1);if(this._repeat){if(c<0){c=b-1;}else{if(c>=b){c=0;}}}else{if(c<0){c=0;}else{if(c>=b){return;}}}this.trackIndex=c;this._playTrack(c);}},_processAction:function(a){this._playTrack(a.trackIndex);},_processOpen:function(a){this._displayTracks(a.query);},_processPlay:function(c){if(this.sound){if(this.sound.paused){Core.Web.Scheduler.add(this._playUpdateRunnable);this.sound.resume();this._trackDisplay.setPlayingTrack(this.trackIndex,false);this._playButton.set("icon",this._r.i["Music.Pause"]);}else{Core.Web.Scheduler.remove(this._playUpdateRunnable);this.sound.pause();this._trackDisplay.setPlayingTrack(this.trackIndex,true);this._playButton.set("icon",this._r.i["Music.Play"]);}}else{if(!this.currentTrack){var a=this._trackDisplay.getTrack(0);if(a){this._loadTrack(a);}else{return;}}try{this.sound=soundManager.createSound({id:"player",url:this._syncAudio.getUrl(this.currentTrack),isMovieStar:WS.Music.MOVIE_STAR_FORMATS[this.currentTrack.type],volume:this._calculateSoundManagerVolume(),onfinish:Core.method(this,this._processSoundFinish)});
if(!this.sound){Core.Debug.consoleWrite("Could not create audio player.");this._displayErrorMediaLoad();return;}this.sound.play();}catch(b){Core.Debug.consoleWrite(b);this.sound=null;this._displayErrorMediaLoad();}Core.Web.Scheduler.add(this._playUpdateRunnable);this._playButton.set("icon",this._r.i["Music.Pause"]);Core.Debug.consoleWrite(Core.Debug.toString(this.sound));}},_processSoundFinish:function(a){Core.Debug.consoleWrite("PSF");this._playTrackNext(false);},_processSetTrackPosition:function(a){if(!this.sound||!this.sound.duration){return;}this.sound.setPosition(this.sound.duration*a.value/100);this._updateState();},_processShuffle:function(a){this._shuffle=a;if(!a){this._shuffleOrder=null;}},_processStop:function(a){if(this.sound){Core.Web.Scheduler.remove(this._playUpdateRunnable);this._playButton.set("icon",this._r.i["Music.Play"]);soundManager.destroySound("player");this.sound=null;}this._updateState();},_processTrackNavigate:function(a){this._playTrackNext(a.actionCommand==="previous");
},refresh:function(){this._doRefresh();},_setActiveDisplay:function(a){this._contentArea.removeAll();if(this._activeDisplay){this._activeDisplay.removeListener("action",this._processActionRef);this._activeDisplay.removeListener("open",this._processOpenRef);}this._activeDisplay=a;this._activeDisplay.addListener("action",this._processActionRef);this._activeDisplay.addListener("open",this._processOpenRef);this._contentArea.add(this._activeDisplay);},_setVolume:function(a){this._volume=a;this._volumeLabel.set("text",Math.round(this._volume/100*11));this._volumeSlider.set("value",this._volume);this._volumeSlider.set("valueColor",Echo.Sync.Color.blend("#7f7f7f","#33B5E5",this._volume/100));if(this.sound){this.sound.setVolume(this._calculateSoundManagerVolume());}},_updateState:function(){if(this.sound&&this.currentTrack&&this.currentTrack.duration){var a=this.currentTrack.duration*1000;this._completedTimeLabel.set("text",WS.Util.formatTimeMSS(this.sound.position/1000));this._remainingTimeLabel.set("text",WS.Util.formatTimeMSS(Math.max(0,a-this.sound.position)/1000));
this._trackProgress.set("value",100*this.sound.position/a);}else{this._completedTimeLabel.set("text","0:00");this._remainingTimeLabel.set("text","0:00");this._trackProgress.set("value",0);}WS.accessMonitor.touch(true);}});WS.Music.IndexModel=Core.extend(WS.CacheViewerModel,{_syncAudio:null,emptyFetch:40,overFetch:20,$construct:function(a,b){WS.CacheViewerModel.call(this);this._syncAudio=a;switch(b){case"albums":this._listMethod=Core.method(this._syncAudio,this._syncAudio.listAlbums);break;case"artists":this._listMethod=Core.method(this._syncAudio,this._syncAudio.listArtists);break;case"playlists":this._listMethod=Core.method(this._syncAudio,this._syncAudio.listPlaylists);break;default:throw new Error("Illegal type: "+b);}},fetchImpl:function(b,a){this._listMethod(Core.method(this,this._processItems),b,a);},_processItems:function(a){this.cacheStore(a.startIndex,a.endIndex,a.items,a.count);}});WS.Music.IndexRenderer=Core.extend(Extras.Sync.FlowViewer.Renderer,{$load:function(){var a=document.createElement("div");
a.appendChild(document.createTextNode("Test Height"));this._textHeight=new Core.Web.Measure.Bounds(a).height;},_loadingDiv:null,_cellHeight:null,_cellWidth:null,_imageWidth:null,_imageHeight:null,$construct:function(b,c,d){this._processImageLoadRef=Core.method(this,this._processImageLoad);this._r=WS.getResources();this._syncAudio=b;this._type=c;switch(c){case"albums":this._defaultIcon=this._r.i["Music.DefaultAlbum"];this._textLines=2;break;case"artists":this._defaultIcon=this._r.i["Music.DefaultArtist"];this._textLines=1;break;case"playlists":this._defaultIcon=this._r.i["Music.DefaultPlaylist"];this._textLines=1;break;default:throw new Error("Illegal type: "+c);}this._styleData=d=d||{};this._border=d.border;this._selectedBorder=d.selectedBorder;this._borderInsetsPx=Echo.Sync.Insets.toPixels(d.border?d.border.contentInsets:null);this._borderWidth=this._borderInsetsPx.left+this._borderInsetsPx.right;this._borderHeight=this._borderInsetsPx.top+this._borderInsetsPx.bottom;this._imageHeight=128;
this._imageWidth=128;this._ar=this._imageWidth/this._imageHeight;this._contentWidth=this._imageWidth;this._cellWidth=this._contentWidth+this._borderWidth;this._contentHeight=5+this._imageHeight+WS.Music.IndexRenderer._textHeight*this._textLines;this._cellHeight=this._contentHeight+this._borderHeight;this._loadingDiv=document.createElement("div");this._loadingDiv.style.width=this._cellWidth+"px";this._loadingDiv.style.height=this._cellHeight+"px";var a=document.createElement("img");a.style.paddingLeft=((this._cellWidth-96)/2)+"px";a.style.paddingTop=((this._cellHeight-96)/2)+"px";a.src=this._r.i["FlowViewer.LoadingIcon"];this._loadingDiv.appendChild(a);},dispose:function(e,c,d,b,a){},getCellSize:function(){return{width:this._cellWidth,height:this._cellHeight};},_processImageLoad:function(b){var a=Core.Web.DOM.getEventTarget(b);this._fitImage(a);},_fitImage:function(c){var d=parseInt(c.width,10);var a=parseInt(c.height,10);if(d>this._imageWidth||a>this._imageHeight){var b=d/a;if(b>this._ar){d=this._imageWidth;
a=Math.floor(this._imageWidth/b);}else{a=this._imageHeight;d=Math.floor(this._imageHeight*b);}c.width=d;c.height=a;}c.style.paddingTop=((this._imageHeight-a)/2)+"px";},_getTextNumber:function(b){var c=0;for(var a=0;a<b.length;++a){c+=b.charCodeAt(a)*((c%2===0)?15:1);}return c;},render:function(n,e,k,c,d){if(!e){c.appendChild(this._loadingDiv.cloneNode(true));return;}var g=d&&d.selected;var a=document.createElement("div");a.style.cssText="width:"+this._cellWidth+"px;"+"height:"+this._cellHeight+"px;";var m=document.createElement("div");m.style.cssText="width:"+this._contentWidth+"px;height:"+this._contentHeight+"px;overflow:hidden;";Echo.Sync.Color.render(this._styleData.background,m,"backgroundColor");Echo.Sync.Color.render(this._styleData.foreground,m,"color");var o=document.createElement("div");o.style.cssText="overflow:hidden;text-align:center;height:"+this._imageHeight+"px";var h;if(e.art){h=document.createElement("img");h.src=this._syncAudio.getArtUrl(e.id);if(h.complete){this._fitImage(h);
}else{Core.Web.DOM.addEventListener(h,"load",this._processImageLoadRef,false);}o.appendChild(h);}else{var f=this._getTextNumber(e.name+"/"+e.artist);o.style.backgroundColor=WS.RGB.fromHsv(f%360,0.5,0.7).toHexTriplet();h=document.createElement("img");h.style.paddingTop=((this._imageHeight-96)/2)+"px";h.src=this._defaultIcon;h.style.marginLeft="-5px";o.appendChild(h);}m.appendChild(o);var b=document.createElement("div");b.style.cssText="overflow:hidden;height:"+(this._contentHeight-this._imageHeight)+"px;"+"font-family:RobotoLight;font-size:12pt;";Echo.Sync.Color.render(this._styleData.titleBackground,b,"backgroundColor");Echo.Sync.Color.render(this._styleData.titleForeground,b,"color");m.appendChild(b);var l=document.createElement("div");l.style.cssText="white-space:nowrap;text-align:center;";l.appendChild(document.createTextNode(e.name||"\u00a0"));b.appendChild(l);if(this._type=="albums"){var j=document.createElement("div");j.style.cssText="white-space:nowrap;color:#afafaf;text-align:center;font-size:8pt;";
j.appendChild(document.createTextNode(e.artist||"\u00a0"));b.appendChild(j);}var i=Echo.Sync.FillImageBorder.renderContainer(g?this._selectedBorder:this._border,{child:m,absolute:false});a.appendChild(i);c.appendChild(a);Echo.Sync.FillImageBorder.renderContainerDisplay(i);}});WS.Music.IndexDisplay=Core.extend(Echo.ContentPane,{$construct:function(a,b){this._r=WS.getResources();this._model=a;this._renderer=b;this.view=new Extras.FlowViewer({background:"#6f6f5f",model:this._model,renderer:this._renderer,events:{action:Core.method(this,this._processAction)}});Echo.ContentPane.call(this,{children:[this.view]});},_processAction:function(b){var a=this._model.get(b.index);if(!a){return;}this.fireEvent({source:this,type:"action",item:a});},setModel:function(a){this._model=a;this.view.set("model",this._model);}});WS.Music.AlbumDisplay=Core.extend(WS.Music.IndexDisplay,{$construct:function(b){this._syncAudio=b;var a=new WS.Music.IndexModel(this._syncAudio,"albums");var c=new WS.Music.IndexRenderer(this._syncAudio,"albums",WS.Style.musicIndexRendererStyle);
WS.Music.IndexDisplay.call(this,a,c);this.addListener("action",Core.method(this,function(d){this.fireEvent({source:this,type:"open",query:{album:d.item.id}});}));},getSelectionQuery:function(){var c=this.view.get("selection");var d=[];for(var b in c){if(c[b]){var a=this._model.get(b);if(a){d.push(a.id);}}}if(d.length===0){return null;}return{albumIds:d};},refresh:function(){this.view.set("selection",null);this.setModel(new WS.Music.IndexModel(this._syncAudio,"albums"));}});WS.Music.ArtistDisplay=Core.extend(Echo.ContentPane,{$construct:function(a){this._syncAudio=a;this._model=new WS.Music.IndexModel(this._syncAudio,"artists");this._r=WS.getResources();this._viewer=new Extras.ListViewer({styleName:"Default",model:this._model,renderer:new WS.Music.ArtistDisplay.Renderer(),columnWidth:["40px","100%"],columnName:["\u00a0",this._r.m["Music.Heading.Artist"]],events:{action:Core.method(this,function(c){var b=this._model.get(c.index);if(!b){return;}this.fireEvent({source:this,type:"open",query:{artist:b.id}});
})}});Echo.ContentPane.call(this,{children:[this._viewer]});},getSelectionQuery:function(){return null;},refresh:function(){this._viewer.set("selection",null);this._model=new WS.Music.IndexModel(this._syncAudio,"artists");this._viewer.set("model",this._model);}});WS.Music.ArtistDisplay.Renderer=Core.extend(Extras.Sync.ListViewer.Renderer,{$construct:function(){Extras.Sync.ListViewer.Renderer.call(this);this._r=WS.getResources();},dispose:function(c,b,d,a){},render:function(c,b,d,a){if(b){a[1].appendChild(document.createTextNode(b.name));}else{a[1].appendChild(document.createTextNode(this._r.m["Music.TrackLoading"]));}}});WS.Music.PlaylistDisplay=Core.extend(Echo.ContentPane,{$construct:function(a){this._syncAudio=a;this._model=new WS.Music.IndexModel(this._syncAudio,"playlists");this._r=WS.getResources();this._viewer=new Extras.ListViewer({styleName:"Default",model:this._model,renderer:new WS.Music.PlaylistDisplay.Renderer(),columnWidth:["40px","100%"],columnName:["\u00a0",this._r.m["Music.Heading.Playlist"]],events:{action:Core.method(this,function(c){var b=this._model.get(c.index);
if(!b){return;}this.fireEvent({source:this,type:"open",query:{playlist:b.id}});})}});Echo.ContentPane.call(this,{children:[this._viewer]});},getSelectionQuery:function(){return null;},refresh:function(){this._viewer.set("selection",null);this._model=new WS.Music.IndexModel(this._syncAudio,"playlists");this._viewer.set("model",this._model);}});WS.Music.PlaylistDisplay.Renderer=Core.extend(Extras.Sync.ListViewer.Renderer,{$construct:function(){Extras.Sync.ListViewer.Renderer.call(this);this._r=WS.getResources();},dispose:function(c,b,d,a){},render:function(c,b,d,a){if(b){a[1].appendChild(document.createTextNode(b.name));}else{a[1].appendChild(document.createTextNode(this._r.m["Music.TrackLoading"]));}}});WS.Music.TrackDisplay=Core.extend(Echo.ContentPane,{$construct:function(a,b){this._syncAudio=a;this._query=b;this._model=new WS.Music.TrackDisplay.Model(a,b);this._r=WS.getResources();this._viewer=new Extras.ListViewer({styleName:"Default",model:this._model,renderer:new WS.Music.TrackDisplay.Renderer(),columnWidth:["40px","40%","30%","30%","5em"],columnName:["\u00a0",this._r.m["Music.Heading.Track"],this._r.m["Music.Heading.Artist"],this._r.m["Music.Heading.Album"],this._r.m["Music.Heading.Duration"]],events:{action:Core.method(this,function(d){var c=this._model.get(d.index);
if(c){Core.Debug.consoleWrite("Loading track: "+Core.Debug.toString(c));this.fireEvent({type:"action",source:this,track:c,trackIndex:d.index});}})}});Echo.ContentPane.call(this,{children:[this._viewer]});},getSelectionQuery:function(){var c=this._viewer.get("selection");var d=[];for(var b in c){if(c[b]){var a=this._model.get(b);if(a){d.push(a.id);}}}if(d.length===0){return null;}return{trackIds:d};},fetchTrack:function(b,a){this._model.fetchSingle(b,a);},getTrack:function(a){return this._model.get(a);},getTrackCount:function(){return this._model.size();},refresh:function(){this._model=new WS.Music.TrackDisplay.Model(this._syncAudio,this._query);this._viewer.set("selection",null);this._viewer.set("model",this._model);},setPlayingTrack:function(c,b){var a=this._viewer._playingTrackIndex;this._viewer._playingTrackIndex=c;this._viewer._paused=b;if(a!=c){this._model.update(a);}this._model.update(c);}});WS.Music.TrackDisplay.Renderer=Core.extend(Extras.Sync.ListViewer.Renderer,{$construct:function(){Extras.Sync.ListViewer.Renderer.call(this);
this._r=WS.getResources();},dispose:function(c,b,d,a){},render:function(e,d,f,c){if(d){var b;var a=!d.type||WS.Music.SUPPORTED_FORMATS[d.type];c[0].style.textAlign="right";if(e._playingTrackIndex===f){b=document.createElement("img");b.src=this._r.i[e._paused?"Music.PlayingTrackPaused":"Music.PlayingTrack"];c[0].appendChild(b);}else{if(!a){b=document.createElement("img");b.src=this._r.i["Music.InvalidFormat"];b.title=this._r.m["Music.InvalidFormat"];c[0].appendChild(b);}}c[1].appendChild(document.createTextNode(d.name));c[2].appendChild(document.createTextNode(d.artist));c[3].appendChild(document.createTextNode(d.album));c[4].appendChild(document.createTextNode(WS.Util.formatTimeMSS(d.duration)));c[4].style.textAlign="right";}else{c[1].appendChild(document.createTextNode(this._r.m["Music.TrackLoading"]));}}});WS.Music.TrackDisplay.Model=Core.extend(WS.CacheViewerModel,{_syncAudio:null,emptyFetch:40,overFetch:20,$construct:function(a,b){WS.CacheViewerModel.call(this);this._syncAudio=a;this._query=b;
},fetchSingle:function(c,a){var b=Core.method(this,function(d){this._processTracks(d);c();});this._syncAudio.listTracks(b,this._query,a,a+1);},fetchImpl:function(b,a){this._syncAudio.listTracks(Core.method(this,this._processTracks),this._query,b,a);},_processTracks:function(a){this.cacheStore(a.startIndex,a.endIndex,a.items,a.count);}});WS.Music.XFileClient=Core.extend(XFile.Client,{_music:null,_syncAudio:null,$construct:function(b,a){this._music=b;this._syncAudio=a;},getUploadUrl:function(){return this._syncAudio.getHtml5UploadUrl();},isReady:function(){return true;},onUploadInit:function(a){a.data.storageBase=this._syncAudio.storageBase;a.data.storagePath="/Music";},onUploadAbort:function(a){},onUploadComplete:function(d){var f=d.upload.id;var a=[];for(var b=0;b<d.items.length;++b){var c={uploadId:d.items[b].data.tempPath,itemPath:d.items[b].path,storageBase:d.data.storageBase,storagePath:d.data.storagePath};a.push(c);}this._music._workspace.addUploadPendingStore(f);this._syncAudio.uploadStore5(Core.method(this,function(e){if(e=="ok"){}else{if(e=="error"){}}}),f,a);
},onUploadItemComplete:function(b){var a=b.request.getResponseHeader("X-WebSharing-Upload-ID");b.item.data.tempPath=a;}});