WS.Photos=Core.extend(WS.WorkspaceModule,{_imageDisplayWindow:null,_activeDisplay:null,_sizeSlider:null,_thumbnailSize:50,$construct:function(){this._r=WS.getResources();this._updateEnabled=WS.user.owner;this._processActionRef=Core.method(this,this._processAction);this._processOpenRef=Core.method(this,this._processOpen);this.fileContributions=[new Extras.OptionModel("downloadphotos",this._r.m["Menu.DownloadPhotos"],this._r.i["Menu.DownloadPhotos"]),new Extras.SeparatorModel(),new Extras.OptionModel("delete",this._r.m["Menu.Delete"],this._r.i["Menu.Delete"])];this.viewContributions=[new Extras.OptionModel("refresh",this._r.m["Menu.Refresh"],this._r.i["Menu.Refresh"])];WS.WorkspaceModule.call(this,{children:[new Extras.ContextMenu({styleName:"Default",stateModel:new WS.FileBrowser.ContextMenuModel(this),model:new Extras.MenuModel(null,null,null,[new Extras.OptionModel("downloadphotos",this._r.m["Menu.DownloadPhotos"],this._r.i["Menu.DownloadPhotos"]),new Extras.SeparatorModel(),new Extras.OptionModel("delete",this._r.m["Menu.Delete"],this._r.i["Menu.Delete"]),new Extras.SeparatorModel(),new Extras.OptionModel("refresh",this._r.m["Menu.Refresh"],this._r.i["Menu.Refresh"])]),children:[this._contentArea=new Echo.ContentPane({})],events:{action:Core.method(this,function(a){this.doOperation(a.modelId);
})}})],events:{init:Core.method(this,function(a){this._syncImage=new WS.Synchronize.Image(this.application.server);this._displayCameraRoll();})}});},activate:function(b){var e;b.sidePane.add(new Echo.ContentPane({background:"#afafaf",foreground:"#4f4f4f",children:[e=new Echo.Column({insets:"10 3 0 10"})]}));e.add(new Echo.Column({insets:"10 10",children:[new Echo.Label({text:this._r.m["Photos.ThumbnailSizePrompt"],font:{italic:true,size:"14pt",typeface:WS.Style.ROBOTO_LIGHT}}),this._sizeSlider=new WS.Slider({minimumInset:"1.5em",maximumInset:"1.5em",border:{top:"1px solid #0f0f0f",left:"1px solid #0f0f0f",right:"1px solid #3f3f3f",bottom:"1px solid #3f3f3f"},background:"#7f7f7f",value:this._thumbnailSize,valueColor:"#efefef",events:{action:Core.method(this,function(f){this._setSize(f.value);})}}),new Echo.Row({width:"100%",children:[new Echo.Label({layoutData:{width:"50%"},text:this._r.m["Photos.ThumbnailSize.Small"],font:{size:"8pt"}}),new Echo.Label({layoutData:{width:"50%",alignment:"right"},text:this._r.m["Photos.ThumbnailSize.Large"],font:{size:"8pt"}})]})]}));
if(WS.mediaIndices.length>1){var a=[];var d=0;for(var c=0;c<WS.mediaIndices.length;++c){a[c]=WS.mediaIndices[c].displayName;if(this._syncImage.mediaIndex==WS.mediaIndices[c].name){d=c;}}e.add(new Echo.Row({cellSpacing:"1ex",children:[new Echo.Label({text:this._r.m["StorageBase.Prompt"]}),new Echo.SelectField({items:a,selection:d,events:{action:Core.method(this,function(g){var f=WS.mediaIndices[g.source.get("selection")||0].name;this._syncImage.mediaIndex=f;WS.pref.mediaIndex=f;WS.savePrefs();this._doRefresh();})}})]}));}if(WS.user.owner){e.add(new Echo.Grid({width:"100%",columnWidth:["50%","50%"],children:[new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Photos.CategoryCameraRoll"],text:this._r.m["Photos.CategoryCameraRoll"],events:{action:Core.method(this,this._displayCameraRoll)}})]}),new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Photos.CategoryImageFolders"],text:this._r.m["Photos.CategoryImageFolders"],events:{action:Core.method(this,this._displayImageFolders)}})]}),new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Photos.CategoryAll"],text:this._r.m["Photos.CategoryAll"],events:{action:Core.method(this,this._displayAll)}})]})]}));
}},_displayAll:function(){this._setActiveDisplay(new WS.Photos.Gallery(this._syncImage,{all:true},this._thumbnailSize));},_displayCameraRoll:function(){this._setActiveDisplay(new WS.Photos.Gallery(this._syncImage,{camera:true},this._thumbnailSize));},_displayFolder:function(a){this._setActiveDisplay(new WS.Photos.Gallery(this._syncImage,{folder:a},this._thumbnailSize));},_displayImageFolders:function(){this._setActiveDisplay(new WS.Photos.FolderList(this._syncImage));},_doDeleteConfirm:function(){var b,j;var d=this._activeDisplay.getSelectionQuery();if(!d){return;}var g=new Echo.Grid({size:2,insets:"1ex 2em",width:"100%"});var a=Core.method(this,function(i){this._displayImageWindow(i.actionCommand);});for(var e=0;e<d.images.length;++e){if(!d.images[e].thumbHeight||!d.images[e].thumbWidth){b=100;j=100;}else{var c=d.images[e].thumbWidth/d.images[e].thumbHeight;if(c>1){b=100;j=Math.floor(b/c);}else{j=100;b=Math.floor(j*c);}}var h={width:b,height:j,url:this._syncImage.getUrl(d.images[e],true)};
g.add(new Echo.Button({actionCommand:d.images[e],icon:h,layoutData:{alignment:{horizontal:"center",vertical:"center"}},events:{action:a}}));}var f=new WS.Workspace.DeleteConfirmDialog(g,Core.method(this,this._doDeleteSelection));this.application.content.add(f);},_doDeleteSelection:function(){var a=this._activeDisplay.getSelectionQuery();if(!a){return;}var b=Core.method(this,function(c){this._doRefresh();});this._syncImage.deleteImage(b,a.imageIds);},_doDownloadPhotos:function(){var a=this._activeDisplay.getSelectionQuery();if(!a){return;}top.location=this._syncImage.getDownloadUrl(a);},doOperation:function(a){switch(a){case"downloadphotos":this._doDownloadPhotos();break;case"delete":this._doDeleteConfirm();break;case"refresh":this._doRefresh();break;}},_doRefresh:function(){this._activeDisplay.refresh();},isOptionEnabled:function(a){switch(a){case"downloadphotos":return this._activeDisplay&&this._activeDisplay.getSelectionQuery()!=null;case"delete":return this._updateEnabled&&this._activeDisplay instanceof WS.Photos.Gallery&&this._activeDisplay.getSelectionQuery()!=null;
default:return true;}},_displayImageWindow:function(a){if(this._imageDisplayWindow&&this._imageDisplayWindow.parent){this._imageDisplayWindow.parent.remove(this._imageDisplayWindow);}this._imageDisplayWindow=new WS.ImageDisplayWindow(this._syncImage.getUrl(a,false));this._imageDisplayWindow.addListener("download",Core.method(this,function(b){top.location=this._syncImage.getDownloadUrl({imageIds:[a.id]});}));this.application.content.add(this._imageDisplayWindow);},_processAction:function(a){this._displayImageWindow(a.image);},_processOpen:function(a){this._displayFolder(a.folder.id);},_setActiveDisplay:function(a){this._contentArea.removeAll();if(this._activeDisplay){this._activeDisplay.removeListener("action",this._processActionRef);this._activeDisplay.removeListener("open",this._processOpenRef);}this._activeDisplay=a;this._activeDisplay.addListener("action",this._processActionRef);this._activeDisplay.addListener("open",this._processOpenRef);this._contentArea.add(this._activeDisplay);},_setSize:function(a){a=Math.min(100,Math.max(0,Math.round(a)));
if(this._thumbnailSize==a){return;}this._thumbnailSize=a;this._sizeSlider.set("value",a);this._activeDisplay.setThumbnailSize(a);}});WS.Photos.FolderList=Core.extend(Echo.ContentPane,{$construct:function(a){this._r=WS.getResources();this._syncImage=a;this._model=new WS.Photos.FolderModel(this._syncImage);this._viewer=new Extras.ListViewer({columnWidth:["40px","100%"],background:"#2f2f2f",foreground:"#ffffff",rolloverEnabled:true,rolloverBackground:"#4f4f4f",selectionForeground:"#afffaf",selectionBackground:"#000000",border:{left:null,top:null,right:null,bottom:"1px solid #1f1f1f"},insets:"4px 25px",model:this._model,renderer:new WS.Photos.FolderRenderer(),events:{action:Core.method(this,function(c){var b=this._model.get(c.index);if(!b){return;}this.fireEvent({source:this,type:"open",folder:b});})}});Echo.ContentPane.call(this,{children:[this._viewer]});},getSelectionQuery:function(){var b=this._viewer.get("selection");var d=[];for(var a in b){if(b[a]){var c=this._model.get(a);if(c){d.push(c.id);
}}}if(d.length===0){return null;}return{folderIds:d};},refresh:function(){this._model=new WS.Photos.FolderModel(this._syncImage);this._viewer.set("selection",null);this._viewer.set("model",this._model);},setThumbnailSize:function(){}});WS.Photos.FolderModel=Core.extend(WS.CacheViewerModel,{$construct:function(a){WS.CacheViewerModel.call(this);this._syncImage=a;},fetchImpl:function(b,a){this._syncImage.listFolders(Core.method(this,this._processFolders),b,a);},_processFolders:function(a){this.cacheStore(a.startIndex,a.endIndex,a.folders,a.count);}});WS.Photos.FolderRenderer=Core.extend(Extras.Sync.ListViewer.Renderer,{$construct:function(){Extras.Sync.ListViewer.Renderer.call(this);this._r=WS.getResources();},dispose:function(c,b,d,a){},render:function(d,c,e,b){if(c){var a=document.createElement("img");a.src=this._r.i["Photos.ImageFolderItem"];b[0].appendChild(a);b[1].appendChild(document.createTextNode(c.name));}}});WS.Photos.Gallery=Core.extend(Echo.ContentPane,{$construct:function(b,c,a){this._r=WS.getResources();
this._syncImage=b;this._query=c;this._model=new WS.Photos.GalleryModel(this._syncImage,this._query);this._viewer=new Extras.FlowViewer({background:"#2f2f2f",backgroundImage:{url:"image/fill/PhotoGrayGradient.png",x:0,repeat:"y"},foreground:"#dfdfdf",model:this._model,renderer:new WS.Photos.GalleryRenderer(this._syncImage,{border:WS.Style.shadowBorder,selectedBorder:WS.Style.shadowBorderHighlight,insets:0},a),events:{action:Core.method(this,function(f){var d=this._model.get(f.index);if(!d){return;}this.fireEvent({source:this,type:"action",image:d});})}});Echo.ContentPane.call(this,{children:[this._viewer]});},getSelectionQuery:function(){var d=this._viewer.get("selection");var c=[];var a=[];for(var b in d){if(d[b]){var e=this._model.get(b);if(e){a.push(e);c.push(e.id);}}}if(c.length===0){return null;}return{imageIds:c,images:a};},refresh:function(){this._model=new WS.Photos.GalleryModel(this._syncImage,this._query);this._viewer.set("selection",null);this._viewer.set("model",this._model);
},setThumbnailSize:function(a){this._viewer.set("renderer",new WS.Photos.GalleryRenderer(this._syncImage,{border:WS.Style.shadowBorder,selectedBorder:WS.Style.shadowBorderHighlight,insets:0},a));}});WS.Photos.GalleryModel=Core.extend(WS.CacheViewerModel,{$construct:function(a,b){WS.CacheViewerModel.call(this);this._syncImage=a;this._query=b;},fetchImpl:function(b,a){this._syncImage.listImages(Core.method(this,this._processImages),this._query,b,a);},_processImages:function(a){this.cacheStore(a.startIndex,a.endIndex,a.images,a.count);}});WS.Photos.GalleryRenderer=Core.extend(Extras.Sync.FlowViewer.Renderer,{_imageHeight:0,_imageWidth:0,_waitLeft:0,_waitTop:0,_loadingDiv:null,$construct:function(d,e,f){this._r=WS.getResources();this._syncImage=d;f=Math.max(0,Math.min(100,f||0));var c=150+(f*3);this._imageHeight=c;this._imageWidth=c;var a=((c-96)/2)+"px";this._loadingDiv=document.createElement("div");this._loadingDiv.style.width=this._imageWidth+"px";this._loadingDiv.style.height=this._imageHeight+"px";
var b=document.createElement("img");b.style.paddingLeft=a;b.style.paddingTop=a;b.src=this._r.i["FlowViewer.LoadingIcon"];this._loadingDiv.appendChild(b);e=e||{};this._border=e.border;this._selectedBorder=e.selectedBorder;this._borderInsetsPx=Echo.Sync.Insets.toPixels(e.border?e.border.contentInsets:null);this._borderWidth=this._borderInsetsPx.left+this._borderInsetsPx.right;this._borderHeight=this._borderInsetsPx.top+this._borderInsetsPx.bottom;this._insetsPx=Echo.Sync.Insets.toPixels(e.insets);this._insetsCss=Echo.Sync.Insets.toCssValue(e.insets)||"0";this._insetWidth=this._insetsPx.left+this._insetsPx.right;this._insetHeight=this._insetsPx.top+this._insetsPx.bottom;this._availableWidth=this._imageWidth-this._borderWidth-this._insetWidth;this._availableHeight=this._imageHeight-this._borderHeight-this._insetHeight;this._availableAR=this._availableWidth/this._availableHeight;},dispose:function(e,c,d,b,a){},getCellSize:function(){return{width:this._imageWidth,height:this._imageHeight};},render:function(k,m,e,n,d){if(!m){n.appendChild(this._loadingDiv.cloneNode(true));
return;}var o=d&&d.selected;var f,b,a,q,g,h,p;if(m.thumbWidth&&m.thumbHeight){f=this._syncImage.getUrl(m,true);b=m.thumbWidth;a=m.thumbHeight;}else{f=this._r.i["Photos.DefaultThumbnail"];b=128;a=128;}var c=b/a;if(c<this._availableAR){h=this._availableWidth;p=Math.floor(h/c);q=0;g=Math.min(0,Math.floor((this._availableHeight-p)/2));}else{p=this._availableHeight;h=Math.floor(p*c);q=Math.min(0,Math.floor((this._availableWidth-h)/2));g=0;}var l=document.createElement("div");l.style.cssText="position: relative;"+"width:"+(this._imageWidth)+"px;"+"height:"+(this._imageHeight)+"px;";var r=document.createElement("img");r.src=f;r.width=h;r.height=p;var j=document.createElement("div");j.style.cssText="position:absolute;overflow:hidden;background-color:#ffffff;"+"width:"+(this._availableWidth-q)+"px;"+"height:"+(this._availableHeight-g)+"px;"+"left:"+q+"px;top:"+g+"px;";j.appendChild(r);var i=Echo.Sync.FillImageBorder.renderContainer(o?this._selectedBorder:this._border,{child:j,absolute:true});i.style.width=(this._availableWidth+this._borderInsetsPx.left+this._borderInsetsPx.right)+"px";
i.style.height=(this._availableHeight+this._borderInsetsPx.top+this._borderInsetsPx.bottom)+"px";l.appendChild(i);n.appendChild(l);}});