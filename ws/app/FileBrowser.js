WS.FileBrowser=Core.extend(WS.WorkspaceModule,{$static:{ContextMenuModel:Core.extend(Extras.MenuStateModel,{_fileBrowser:null,$construct:function(a){this._fileBrowser=a;},isEnabled:function(a){return this._fileBrowser.isOptionEnabled(a);}}),createPath:function(){var a=arguments[0];for(var b=1;b<arguments.length;++b){if(a.charAt(a.length-1)!=="/"){a+="/";}a+=arguments[b];}return a;},getDescription:function(b,a){if(!a){return null;}if(a.directory){return b.m["Generic.Folder"];}else{var c=WS.ContentType.getDescriptor(a.name);return c?c.name:null;}},getIcon:function(c,b){var a="image/icon/icc"+b+"_";var d;if(c.directory){d=a+"folder.png";}else{var e=WS.ContentType.getDescriptor(c.name);d=a+(e==null?"file_generic":e.iconName)+".png";}return d;},getParentPath:function(b){if(b.charAt(b.length-1)==="/"){b=b.substring(0,b.length-1);}var a=b.lastIndexOf("/");if(a===-1){return null;}else{return b.substring(0,a+1);}},fitImage:function(b,e,c,a){var f=b/e;var d=c/a;if(f>d){return{width:c,height:c/f};
}else{return{width:a*f,height:a};}}},_processActionRef:null,_processSelectRef:null,_path:null,_selection:null,_selectionName:null,_clipboard:null,_clipboardSourcePath:null,_clipboardStorageBase:null,_clipboardCopy:false,_syncFile:null,_storageSelect:null,_storageSelectPanel:null,_workspace:null,_xfileClient:null,_activated:false,$construct:function(){this._updateEnabled=WS.user.owner||WS.user.permissions.fileUpdate;this._r=WS.getResources();this._processActionRef=Core.method(this,this._processAction);this._processSelectRef=Core.method(this,this._processSelect);var a=[];a.push(new Extras.OptionModel("newfolder",this._r.m["Menu.NewFolder"],this._r.i["Menu.NewFolder"]));a.push(new Extras.OptionModel("upload",this._r.m["Menu.Upload"],this._r.i["Menu.Upload"]));if(XFile.FOLDER_SUPPORT){a.push(new Extras.OptionModel("uploadfolder",this._r.m["Menu.Upload.Folder"],this._r.i["Menu.Upload"]));}a.push(new Extras.OptionModel("download",this._r.m["Menu.DownloadItems"],this._r.i["Menu.DownloadItems"]));
a.push(new Extras.SeparatorModel());a.push(new Extras.OptionModel("cut",this._r.m["Menu.Cut"],this._r.i["Menu.Cut"]));a.push(new Extras.OptionModel("copy",this._r.m["Menu.Copy"],this._r.i["Menu.Copy"]));a.push(new Extras.OptionModel("paste",this._r.m["Menu.Paste"],this._r.i["Menu.Paste"]));a.push(new Extras.SeparatorModel());a.push(new Extras.OptionModel("delete",this._r.m["Menu.Delete"],this._r.i["Menu.Delete"]));a.push(new Extras.OptionModel("rename",this._r.m["Menu.Rename"],this._r.i["Menu.Rename"]));this.fileContributions=a;this.viewContributions=[new Extras.OptionModel("refresh",this._r.m["Menu.Refresh"],this._r.i["Menu.Refresh"]),new Extras.OptionModel("home",this._r.m["Menu.Home"],this._r.i["Menu.Home"]),new Extras.SeparatorModel(),new Extras.ToggleOptionModel("showHidden",this._r.m["Menu.ShowHiddenFiles"])];WS.WorkspaceModule.call(this,{events:{init:Core.method(this,function(b){this._syncFile=new WS.Synchronize.File(this.application.server);this._xfileClient=new WS.FileBrowser.XFileClient(this,this._syncFile);
this._displayFiles("/");})},children:[this._mainSplit=new Echo.SplitPane({autoPositioned:true,separatorHeight:1,separatorColor:"#bfbfbf",orientation:Echo.SplitPane.ORIENTATION_VERTICAL_TOP_BOTTOM,children:[new Echo.Row({insets:"0px 1ex",children:[this._storageSelectPanel=new Echo.Panel(),this._pathRow=new WS.FileBrowser.PathRow({layoutData:{width:"100%"},foreground:"#7f7f7f",horizontalSpacing:"1ex",events:{action:Core.method(this,function(b){this._doOpenDirectory(b.path);})}})]}),new Extras.ContextMenu({styleName:"Default",stateModel:new WS.FileBrowser.ContextMenuModel(this),model:new Extras.MenuModel(null,null,null,[new Extras.OptionModel("newfolder",this._r.m["Menu.NewFolder"],this._r.i["Menu.NewFolder"]),new Extras.OptionModel("upload",this._r.m["Menu.Upload"],this._r.i["Menu.Upload"]),new Extras.OptionModel("download",this._r.m["Menu.DownloadItems"],this._r.i["Menu.DownloadItems"]),new Extras.SeparatorModel(),new Extras.OptionModel("cut",this._r.m["Menu.Cut"],this._r.i["Menu.Cut"]),new Extras.OptionModel("copy",this._r.m["Menu.Copy"],this._r.i["Menu.Copy"]),new Extras.OptionModel("paste",this._r.m["Menu.Paste"],this._r.i["Menu.Paste"]),new Extras.SeparatorModel(),new Extras.OptionModel("delete",this._r.m["Menu.Delete"],this._r.i["Menu.Delete"]),new Extras.OptionModel("rename",this._r.m["Menu.Rename"],this._r.i["Menu.Rename"]),new Extras.SeparatorModel(),new Extras.OptionModel("refresh",this._r.m["Menu.Refresh"],this._r.i["Menu.Refresh"])]),children:[this._contentArea=new Echo.ContentPane({})],events:{action:Core.method(this,function(b){this.doOperation(b.modelId);
})}})]})]});this._specialPaneContainer=new Extras.AccordionPane({background:"#ffffff",foreground:"#000000",styleName:"Default",animationTime:100});},activate:function(b){this._workspace=b;b.xfile.setClient(this._xfileClient);if(this._specialPaneContainer.parent){this._specialPaneContainer.parent.remove(this._specialPaneContainer);}this._sidePane=new Echo.SplitPane({background:"#5f5f5f",orientation:Echo.SplitPane.ORIENTATION_VERTICAL_TOP_BOTTOM,separatorPosition:"100%",separatorColor:"#232325",children:[new Echo.Column({layoutData:{minimumSize:300},insets:"1em",cellSpacing:"1em",children:[new Echo.Row({width:"100%",children:[this._parentDirectoryButton=new Echo.Button({layoutData:{width:"100%"},disabledForeground:"#afafaf",icon:this._r.i["FileBrowser.ParentDirectoryButton"],text:this._r.m["FileBrowser.ParentDirectoryButton"],events:{action:Core.method(this,this._doOpenParentDirectory)}}),new Echo.RadioButton({layoutData:{alignment:"right"},group:"viewMode",stateIcon:this._r.i["FileBrowser.ViewMode.Icon.Off"],selectedStateIcon:this._r.i["FileBrowser.ViewMode.Icon.On"],selected:!WS.pref.fileListView,events:{action:Core.method(this,function(f){WS.pref.fileListView=false;
this._displayFiles(this._path);WS.savePrefs();})}}),new Echo.RadioButton({layoutData:{alignment:"right"},group:"viewMode",stateIcon:this._r.i["FileBrowser.ViewMode.List.Off"],selectedStateIcon:this._r.i["FileBrowser.ViewMode.List.On"],selected:WS.pref.fileListView,events:{action:Core.method(this,function(f){WS.pref.fileListView=true;this._displayFiles(this._path);WS.savePrefs();})}})]}),new Echo.Column({children:[this._selectionIcon=new Echo.Label({layoutData:{alignment:"center"}}),this._selectionText=new Echo.Label({layoutData:{alignment:"center"},font:{bold:true}}),this._selectionDescription=new Echo.Label({layoutData:{alignment:"center"},foreground:"#efefef",font:{size:"7pt"}}),this._selectionSize=new Echo.Label({layoutData:{alignment:"center"},foreground:"#efefef",font:{size:"7pt"}}),this._selectionDate=new Echo.Label({layoutData:{alignment:"center"},foreground:"#efefef",font:{size:"7pt"}})]})]}),this._specialPaneContainer]});b.sidePane.add(this._sidePane);if(WS.storage.length>1){var a=[];
var d=0;for(var c=0;c<WS.storage.length;++c){a[c]=WS.storage[c].displayName;if(this._syncFile.storageBase==WS.storage[c].name){d=c;}}this._storageSelectPanel.add(this._storageSelect=new Echo.SelectField({selection:d,items:a,events:{action:Core.method(this,function(g){var f=WS.storage[g.source.get("selection")||0].name;this._syncFile.storageBase=f;WS.pref.fileStorageBase=f;WS.savePrefs();this._displayFiles("/");})}}));}if(this._path!=null){this._parentDirectoryButton.setEnabled(!!WS.FileBrowser.getParentPath(this._path));}this._updateClipboard();this._activated=true;},_displayFiles:function(b){this._contentArea.removeAll();this._path=b;this._pathRow.set("path",b);this._mainSplit.set("$update$",b);if(this._parentDirectoryButton){this._parentDirectoryButton.setEnabled(!!WS.FileBrowser.getParentPath(this._path));}this._folderModel=new WS.FileBrowser.FolderModel(this._syncFile,b,this._showHidden);if(WS.pref.fileListView){this._displayFilesAsList();}else{this._displayFilesAsGrid();}if(this._selectionName){var a=this._getFile(this._selectionName);
if(a){this._setSelection([a]);}else{this._setSelection(null);}}else{this._setSelection(null);}},_displayFilesAsList:function(){this._contentArea.removeAll();this._fileViewer=new Extras.ListViewer({styleName:"Default",columnName:["\u00a0",this._r.m["FileBrowser.Name"],this._r.m["FileBrowser.Size"],this._r.m["FileBrowser.Type"],this._r.m["FileBrowser.Date"]],columnWidth:["40px","70%","7em","30%","15em"],model:this._folderModel,renderer:new WS.FileBrowser.FolderListRenderer(),events:{action:this._processActionRef,property:Core.method(this,function(a){if(a.propertyName=="selection"){this._processSelectRef(a);}})}});this._contentArea.add(this._fileViewer);},_displayFilesAsGrid:function(){this._contentArea.removeAll();this._fileViewer=new Extras.FlowViewer({model:this._folderModel,renderer:new WS.FileBrowser.FolderGridRenderer(),events:{action:this._processActionRef,property:Core.method(this,function(a){if(a.propertyName=="selection"){this._processSelectRef(a);}})}});this._contentArea.add(this._fileViewer);
},_doCopy:function(a){this._clipboard=this._selection;this._clipboardStorageBase=this._syncFile.storageBase;this._clipboardCopy=true;this._clipboardSourcePath=this._path;this._updateClipboard();},_doCut:function(a){this._clipboard=this._selection;this._clipboardStorageBase=this._syncFile.storageBase;this._clipboardCopy=false;this._clipboardSourcePath=this._path;this._updateClipboard();},_doClearClipboard:function(){this._clipboard=null;this._clipboardStorageBase=null;this._clipboardSourcePath=null;this._updateClipboard();},_doDeleteConfirm:function(){if(!this._selection||this._selection.length===0){return;}var c=new Echo.Column();for(var b=0;b<this._selection.length;++b){c.add(new Echo.Label({icon:WS.FileBrowser.getIcon(this._selection[b],24),text:this._selection[b].name}));}var a=new WS.Workspace.DeleteConfirmDialog(c,Core.method(this,this._doDeleteSelected));this.application.content.add(a);},_doDeleteSelected:function(){var a=[];for(var b=0;b<this._selection.length;++b){a.push(this._selection[b].name);
}this._syncFile.deleteFile(Core.method(this,function(c){switch(c){case"error":this.application.displayError();break;case"ok":this._doRefresh();break;}}),this._path,a);},_doDownload:function(a){var b=a?[a]:this._selection;if(b.length===0){return;}if(b.length===1&&!b[0].directory){top.location=this._getFileUrl(b[0],true);}else{top.location=this._getDownloadUrl();}},_doNewFolder:function(){var b,a;var d=Core.method(this,function(g){if(b.parent){b.parent.remove(b);}if("ok"==g.actionCommand){var f=a.get("text");this._syncFile.newFolder(Core.method(this,function(e){switch(e){case"exists":this.application.displayError(null,this._r.m["FileBrowser.NewFolder.ErrorExists"]);break;case"error":this.application.displayError();break;case"ok":this._selectionName=f;this._doRefresh();break;}}),this._path,f);}});var c=new Echo.Column({layoutData:{width:"100%"},cellSpacing:"1ex",children:[new Echo.Label({text:this._r.m["FileBrowser.NewFolder.Prompt"]}),a=new Echo.TextField({styleName:"Default",width:"100%",actionCommand:"ok",events:{action:d}})]});
b=new WS.Dialog(this._r.m["FileBrowser.NewFolder.Title"],this._r.i["FileBrowser.NewFolder.Icon"],c,null,WS.Dialog.CONTROLS_OK_CANCEL);b.addListener("action",d);this.application.content.add(b);this.application.setFocusedComponent(a);},_doOpenChildDirectory:function(a){this._setSelection(null);this._displayFiles(WS.FileBrowser.createPath(this._path,a.name));},_doOpenDirectory:function(a){this._setSelection(null);this._displayFiles(a);},_doOpenHomeDirectory:function(){this._setSelection(null);this._displayFiles("/");},_doOpenImage:function(a){this.application.client.exec(WS.MODULE_DISPLAY_IMAGE,Core.method(this,function(){this._displayWindow=new WS.ImageDisplayWindow(this._getFileUrl(a,false));this._displayWindow.addListener("download",Core.method(this,function(b){top.location=this._getFileUrl(a,true);}));this.application.content.add(this._displayWindow);}));},_doOpenParentDirectory:function(){this._setSelection(null);var a=WS.FileBrowser.getParentPath(this._path);if(a){this._displayFiles(a);
}},_doOpenText:function(a){this.application.client.exec(WS.MODULE_DISPLAY_TEXT,Core.method(this,function(){this._displayWindow=new WS.TextDisplayWindow(this._getFileUrl(a,false,65536));this._displayWindow.addListener("download",Core.method(this,function(b){top.location=this._getFileUrl(a,true);}));this.application.content.add(this._displayWindow);}));},doOperation:function(a){switch(a){case"upload":if(XFile.SUPPORT){if(this._workspace){this._workspace.xfile.choose(false);}}else{this.application.client.exec(WS.MODULE_UPLOAD,Core.method(this,this._doUpload));}break;case"uploadfolder":if(this._workspace){this._workspace.xfile.choose(true);}break;case"newfolder":this._doNewFolder();break;case"download":this._doDownload();break;case"cut":this._doCut();break;case"copy":this._doCopy();break;case"paste":this._doPaste();break;case"rename":this._doRename();break;case"delete":this._doDeleteConfirm();break;case"home":this._doOpenHomeDirectory("/");break;case"refresh":this._doRefresh();break;}},_doPaste:function(c){if(!this._clipboard||this._clipboard.length===0){return;
}var a=[];for(var b=0;b<this._clipboard.length;++b){a[b]=this._clipboard[b].name;}this._syncFile.relocateFiles(Core.method(this,function(d){switch(d){case"ok":this._doClearClipboard();this._doRefresh();break;case"error:exists":this.application.displayError(null,this._r.m["FileBrowser.Relocate.ErrorExists"]);break;case"error:nesting":this.application.displayError(null,this._r.m["FileBrowser.Relocate.ErrorNesting"]);break;default:this.application.displayError();break;}}),this._clipboardStorageBase,this._clipboardSourcePath,a,this._path,this._clipboardCopy);},_doRefresh:function(){this._displayFiles(this._path);},refreshPath:function(a,b){if(this._syncFile.storageBase!=a||this._path!=b){return;}this._doRefresh();},_doRename:function(){if(!this._selection||this._selection.length!==1){return;}var c=this._selection[0];var b,a,d=c.name;var f=Core.method(this,function(h){if(b.parent){b.parent.remove(b);}if("ok"==h.actionCommand){var g=a.get("text");if(d==g){return;}this._syncFile.renameFile(Core.method(this,function(i){switch(i){case"error:exists":this.application.displayError(null,this._r.m["FileBrowser.Rename.ErrorExists"]);
break;case"error":this.application.displayError();break;case"ok":this._selectionName=g;this._doRefresh();break;}}),WS.FileBrowser.createPath(this._path,d),g);}});var e=new Echo.Grid({layoutData:{width:"100%"},width:"100%",cellSpacing:"1ex",children:[new Echo.Label({icon:WS.FileBrowser.getIcon(c,64)}),a=new Echo.TextField({text:c.name,styleName:"Default",width:"100%",actionCommand:"ok",events:{action:f}})]});b=new WS.Dialog(this._r.m["FileBrowser.Rename.Title"],this._r.i["FileBrowser.Rename.Icon"],e,null,WS.Dialog.CONTROLS_OK_CANCEL);b.addListener("action",f);this.application.content.add(b);this.application.setFocusedComponent(a);},_doUpload:function(){var c=this._syncFile.storageBase;var d=this._path;var b=this._syncFile.getUploadUrl(WS.pref.multipleUpload);var a=new WS.Upload.Dialog({receiver:b,title:this._r.m["Upload.WindowTitle"],fileDescription:this._r.m["Upload.WindowTitle"],prompt:this._r.m["Upload.Prompt"],multiple:WS.pref.multipleUpload});a.addListener("action",Core.method(this,function(f){this._syncFile.uploadStore(Core.method(this,function(e){if(e=="error"){this.application.displayError();
}else{if(e=="ok"){if(this._path==d){this._doRefresh();}}}}),f.fileId,c,d);}));this.application.content.add(a);},_getFile:function(a){for(var b in this._files){if(this._files[b].name==a){return this._files[b];}}return null;},_getDownloadUrl:function(){var b=[];for(var a=0;a<this._selection.length;++a){b[a]=WS.FileBrowser.createPath(this._path,this._selection[a].name);}return this._syncFile.getDownloadUrl(b);},_getFileStreamUrl:function(a){return this._syncFile.getStreamUrl(WS.FileBrowser.createPath(this._path,a.name));},_getFileUrl:function(c,b,a){return this._syncFile.getUrl(WS.FileBrowser.createPath(this._path,c.name),b,a);},getPath:function(){return this._path;},getUploadClient:function(){return new WS.FileBrowser.UploadClient(this);},isOptionEnabled:function(a){switch(a){case"newfolder":case"upload":return this._updateEnabled;case"download":return this._updateEnabled&&this._selection&&this._selection.length>0;case"rename":return this._updateEnabled&&this._selection&&this._selection.length===1;
case"delete":return this._updateEnabled&&this._selection&&this._selection.length>0;case"home":return this._path!="/";case"cut":return this._updateEnabled&&this._selection&&this._selection.length>0;case"copy":return this._updateEnabled&&this._selection&&this._selection.length>0;case"paste":return this._clipboard&&this._clipboard.length>0;default:return true;}},isOptionSelected:function(a){if(a=="showHidden"){return this._showHidden;}else{return false;}},_processAction:function(c){var a=this._folderModel.get(c.index);if(!a){return;}if(a.directory){this._doOpenChildDirectory(a);}else{var b=WS.ContentType.getDescriptor(a.name);if(!b){this._doDownload(a);}else{if(b.canDisplayAsText()){this._doOpenText(a);}else{if(b.canDisplayAsImage()){this._doOpenImage(a);}else{if(b.canDisplayAsVideo()&&(WS.pref.videoAuto||WS.pref.videoFlash||WS.pref.videoHtml5)){var d=WS.ContentType.getContentType(a.name);this.application.displayVideo(d,this._getFileStreamUrl(a),this._getFileUrl(a,true));}else{this._doDownload(a);
}}}}}},_processSelect:function(c){var b=c.newValue;var d=[];if(b){for(var a in b){d.push(this._folderModel.get(a));}}this._setSelection(d);},setOptionSelected:function(b,a){if(b=="showHidden"){this._showHidden=a;this._doRefresh();}},_setSelection:function(c){if(!this._activated){return;}this._selectionName=null;this._selection=c;if(this._selection&&this._selection.length>0){if(this._selection.length===1){this._selectionIcon.set("icon",{url:WS.FileBrowser.getIcon(c[0],128)});this._selectionText.set("text",c[0].name);this._selectionDescription.set("text",WS.FileBrowser.getDescription(this._r,c[0]));this._selectionSize.set("text",c[0].size?WS.Util.formatBytes(c[0].size):null);this._selectionDate.set("text",c[0].date?WS.Util.formatDate(this._r,c[0].date):null);}else{this._selectionIcon.set("icon",{url:this._r.i["FileBrowser.MultipleFiles"]});this._selectionText.set("text",this._r.m["FileBrowser.MultipleFiles"]);this._selectionDescription.set("text",this._selection.length+" "+this._r.m["FileBrowser.NFilesSelected"]);
this._selectionDate.set("text",null);var b=0;var d=false;for(var a=0;a<this._selection.length;++a){b+=this._selection[a].size||0;d|=this._selection[a].directory;}if(b){var e=(d?">= ":"")+WS.Util.formatBytes(b);this._selectionSize.set("text",e);}else{this._selectionSize.set("text",null);}}}else{this._selectionIcon.set("icon",null);this._selectionText.set("text",null);this._selectionDescription.set("text",null);this._selectionSize.set("text",null);this._selectionDate.set("text",null);}},_addSpecialPane:function(a){this._sidePane.set("separatorPosition","65%");this._sidePane.set("separatorHeight",3);this._sidePane.set("resizable",true);this._specialPaneContainer.add(a);if(this._specialPaneContainer.getComponentCount()>1){this._specialPaneContainer.set("activeTabIndex",this._specialPaneContainer.getComponentCount()-1);}},_removeSpecialPane:function(a){this._specialPaneContainer.remove(a);if(this._specialPaneContainer.getComponentCount()===0){this._sidePane.set("separatorPosition","100%");this._sidePane.set("resizable",false);
this._sidePane.set("separatorHeight",0);}},_updateClipboard:function(){if(this._clipboardPane){this._removeSpecialPane(this._clipboardPane);}if(!this._clipboard||this._clipboard.length===0){return;}var b;this._clipboardPane=new Echo.SplitPane({layoutData:{title:this._r.m["FileBrowser.Clipboard.Contents"]},autoPositioned:true,orientation:Echo.SplitPane.ORIENTATION_VERTICAL_BOTTOM_TOP,children:[new Echo.Row({styleName:"ControlPane",children:[new Echo.Button({styleName:"ControlPane",text:"Clear",events:{action:Core.method(this,this._doClearClipboard)}}),new Echo.Button({styleName:"ControlPane",text:"Paste",events:{action:Core.method(this,this._doPaste)}})]}),b=new Echo.Column({children:[new Echo.Label({styleName:"FileBrowser.SidePane.DescriptionLabel",icon:this._r.i[this._clipboardCopy?"FileBrowser.Clipboard.CopyIndicator":"FileBrowser.Clipboard.CutIndicator"],text:this._r.m[this._clipboardCopy?"FileBrowser.Clipboard.CopyPrompt":"FileBrowser.Clipboard.CutPrompt"]})]})]});for(var a=0;a<this._clipboard.length;
++a){b.add(new Echo.Label({layoutData:{insets:"0 5"},icon:WS.FileBrowser.getIcon(this._clipboard[a],24),text:this._clipboard[a].name}));}this._addSpecialPane(this._clipboardPane);}});WS.FileBrowser.XFileClient=Core.extend(XFile.Client,{_fileBrowser:null,_syncFile:null,$construct:function(b,a){this._fileBrowser=b;this._syncFile=a;},getUploadUrl:function(){return this._syncFile.getHtml5UploadUrl();},isReady:function(){return true;},onUploadInit:function(a){a.data.storageBase=this._syncFile.storageBase;a.data.storagePath=this._fileBrowser.getPath();},onUploadAbort:function(a){},onUploadComplete:function(d){var f=d.upload.id;var a=[];for(var b=0;b<d.items.length;++b){var c={uploadId:d.items[b].data.tempPath,itemPath:d.items[b].path,storageBase:d.data.storageBase,storagePath:d.data.storagePath};a.push(c);}this._fileBrowser._workspace.addUploadPendingStore(f);this._syncFile.uploadStore5(Core.method(this,function(e){if(e=="ok"){this._fileBrowser.refreshPath(d.data.storageBase,d.data.storagePath);
}else{if(e=="error"){}}}),f,a);},onUploadItemComplete:function(b){var a=b.request.getResponseHeader("X-WebSharing-Upload-ID");b.item.data.tempPath=a;}});WS.FileBrowser.ThumbnailRetrievalQueue=Core.extend({_queue:null,_pendingRequest:false,_onThumbnailListener:null,$construct:function(a){this._onThumbnailListener=a;this._queue=[];},add:function(b,f,a,e,c,d){this._queue.push({modelValue:b,dataUrl:f,generationUrl:a,path:e,element:c,resources:d});this._sendRequest();},_processResponse:function(b,c){if(!c.valid){Core.Debug.consoleWrite("Invalid response: "+Core.Debug.toString(c));return;}var a=c.source.getResponseXml();if(!a||!a.documentElement){Core.Debug.consoleWrite("Invalid response: no document."+Core.Debug.toString(c));return;}WS.Synchronize.File.processThumbnailData(a.documentElement,b.modelValue);if(b.modelValue.thumbnailReady){this._onThumbnailListener({dataUrl:b.dataUrl,generationUrl:b.generationUrl,element:b.element,resources:b.resources,path:b.path,modelValue:b.modelValue});}},_sendRequest:function(){if(this._pendingRequest||this._queue.length===0){return;
}var b=null;while(true){if(this._queue.length===0){this._pendingRequest=false;return;}b=this._queue.shift();if(Core.Web.DOM.isDisplayed(b.element)){break;}}var a=new Core.Web.HttpConnection(b.generationUrl,"GET");a.addResponseListener(Core.method(this,function(c){try{this._processResponse(b,c);}finally{this._pendingRequest=false;this._sendRequest();}}));a.connect();this._pendingRequest=true;}});WS.FileBrowser.FolderModel=Core.extend(WS.CacheViewerModel,{emptyFetch:256,overFetch:128,path:null,$construct:function(b,c,a){WS.CacheViewerModel.call(this);this.syncFile=b;this.path=c;this._query={path:c,showHidden:a};},fetchImpl:function(b,a){this.syncFile.listFiles(Core.method(this,this._processFiles),this._query,b,a);},_processFiles:function(a){if(a.error){WS.App.displayError();return;}this.cacheStore(a.startIndex,a.endIndex,a.files,a.count);}});WS.FileBrowser.FolderListRenderer=Core.extend(Extras.Sync.ListViewer.Renderer,{_queue:null,$construct:function(){Extras.Sync.ListViewer.Renderer.call(this);
this._r=WS.getResources();this._iconSize=24;this._queue=new WS.FileBrowser.ThumbnailRetrievalQueue(Core.method(this,this._onThumbnailListener));},dispose:function(c,b,d,a){},_onThumbnailListener:function(a){this._renderThumbnail(a.element,a.path,a.modelValue,a.dataUrl);},render:function(h,c,i,g){if(!c){return;}var f=h.get("model");var j=WS.FileBrowser.createPath(f.path,c.name);var k=c.size==null?"":WS.Util.formatBytes(c.size);var b=c.date==null?"":WS.Util.formatDate(this._r,c.date);var e=document.createElement("img");var a=f.syncFile.getThumbnailUrl(j);if(c.thumbnailReady){this._renderThumbnail(e,j,c,a);}else{e.src=WS.FileBrowser.getIcon(c,24);}g[0].appendChild(e);g[1].appendChild(document.createTextNode(c.name));g[2].appendChild(document.createTextNode(k));g[3].appendChild(document.createTextNode(WS.FileBrowser.getDescription(this._r,c)||""));g[4].appendChild(document.createTextNode(b));g[0].style.textAlign="center";g[2].style.textAlign="right";if(!c.thumbnailReady&&c.thumbnailAvailable){var d=f.syncFile.getThumbnailGenerationUrl(j);
this._queue.add(c,a,d,j,e,{});}},_renderThumbnail:function(b,e,a,d){var c=WS.FileBrowser.fitImage(a.thumbnailWidth,a.thumbnailHeight,this._iconSize,this._iconSize);b.src=d;b.width=c.width;b.height=c.height;}});WS.FileBrowser.FolderGridRenderer=Core.extend(Extras.Sync.FlowViewer.Renderer,{_queue:null,$load:function(){var a=document.createElement("div");a.appendChild(document.createTextNode("Test Height"));this._textHeight=new Core.Web.Measure.Bounds(a).height;},$construct:function(){Extras.Sync.FlowViewer.Renderer.call(this);this._r=WS.getResources();this._queue=new WS.FileBrowser.ThumbnailRetrievalQueue(Core.method(this,this._onThumbnailListener));this._paddingWidth=10;this._paddingHeight=8;this._iconTextMargin=0;this._iconSize=64;this._cellWidth=150;this._cellHeight=this._iconSize+WS.FileBrowser.FolderGridRenderer._textHeight+(this._paddingHeight*2)+this._iconTextMargin;var a="overflow:hidden;white-space:nowrap;text-align:center;";this._divNormalCssText=a+"padding-left:"+this._paddingWidth+"px;"+"padding-right:"+this._paddingWidth+"px;"+"padding-top:"+this._paddingHeight+"px;"+"padding-bottom:"+this._paddingHeight+"px;";
this._divSelectedCssText=a+"padding-left:"+(this._paddingWidth)+"px;"+"padding-right:"+(this._paddingWidth)+"px;"+"padding-top:"+(this._paddingHeight)+"px;"+"padding-bottom:"+(this._paddingHeight)+"px;"+"background:"+WS.Style.BG_SELECTION;},dispose:function(c,b,d,a){},getCellSize:function(){return{width:this._cellWidth,height:this._cellHeight};},_onThumbnailListener:function(a){this._renderThumbnail(a.resources.imgDiv,a.element,a.path,a.modelValue,a.dataUrl);},render:function(j,e,i,b,c){if(!e){return;}var a=document.createElement("div");a.style.cssText=c.selected?this._divSelectedCssText:this._divNormalCssText;var l=document.createElement("div");var g=document.createElement("img");var h=j.get("model");var k=WS.FileBrowser.createPath(h.path,e.name);var d=h.syncFile.getThumbnailUrl(k);if(e.thumbnailReady){this._renderThumbnail(l,g,k,e,d);}else{l.style.cssText="padding-bottom:"+this._iconTextMargin+"px";g.src=WS.FileBrowser.getIcon(e,this._iconSize);}l.appendChild(g);a.appendChild(l);a.appendChild(document.createTextNode(e.name));
b.appendChild(a);if(!e.thumbnailReady&&e.thumbnailAvailable){var f=h.syncFile.getThumbnailGenerationUrl(k);this._queue.add(e,d,f,k,g,{imgDiv:l});}},_renderThumbnail:function(e,c,g,b,f){var d=WS.FileBrowser.fitImage(b.thumbnailWidth,b.thumbnailHeight,this._iconSize,this._iconSize);c.src=f;c.width=d.width;c.height=d.height;var a=(this._iconSize-d.height)/2;var h=this._iconTextMargin+this._iconSize-d.height-a;e.style.cssText="padding-top:"+a+"px;padding-bottom:"+h+"px";}});WS.FileBrowser.PathRow=Core.extend(Echo.Row,{$construct:function(a){this._r=WS.getResources();WS.Flow.call(this,a);this._actionRef=Core.method(this,this._processAction);this.addListener("property",Core.method(this,function(b){if(b.propertyName=="path"){this._pathChanged(b.newValue);}}));this._pathChanged([]);},_pathChanged:function(c){this.removeAll();if(c.length>0&&c.charAt(c.length-1)=="/"){c=c.substring(0,c.length-1);}if(c.length===0||c.charAt(0)!="/"){c="/"+c;}var a=c=="/"?[""]:c.split("/");for(var b=0;b<a.length;++b){if(b>0||WS.storage.length>1){this.add(new Echo.Label({layoutData:{width:20,backgroundImage:{url:"image/misc/PathSeparatorChevron.png",x:"50%",y:"50%"}},icon:{url:"lib/echo/resource/Transparent.gif",width:"20"}}));
}this.add(new Echo.Button({layoutData:{insets:"4 0"},actionCommand:a.slice(0,b+1).join("/")+"/",rolloverEnabled:true,rolloverBorder:{top:0,left:0,right:0,bottom:"2px solid #33B5E5"},font:{typeface:WS.Style.ROBOTO_LIGHT,size:"12pt"},insets:"2 0",lineWrap:false,iconTextMargin:1,text:(b===0?this._r.m["FileBrowser.PathRow.FolderHome"]:a[b]),events:{action:this._actionRef}}));}this.children[this.children.length-1].set("rolloverBackground",null);},_processAction:function(a){this.fireEvent({source:this,type:"action",path:a.actionCommand});}});