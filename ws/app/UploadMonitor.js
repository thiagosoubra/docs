WS.UploadMonitor=Core.extend(WS.EventContainer,{_progressSlider:null,_contentPane:null,_detailWindow:null,_titleLabel:null,_uploading:-1,$construct:function(a){this._contentPane=a;this._r=WS.getResources();WS.EventContainer.call(this,{events:{action:Core.method(this,this._doDetail)},children:[new Echo.Row({border:{top:"1px solid #33B5E5",bottom:null,right:null,left:null},foreground:"#ffffff",background:"#002e3e",cellSpacing:20,insets:10,children:[this._titleLabel=new Echo.Label({layoutData:{alignment:"bottom"},text:this._r.m["UploadProgress.Title.Uploading"],italic:true,font:{typeface:WS.Style.ROBOTO_LIGHT,size:"17pt"}}),this._itemsIndicator=new Echo.Label({layoutData:{alignment:"bottom"},text:"0/0",italic:true,foreground:"#9f9f9f",font:{typeface:WS.Style.ROBOTO_LIGHT,size:"20pt"}}),new Echo.Column({layoutData:{width:500},children:[this._progressSlider=new WS.Slider({height:5,minimumInset:"1.5em",maximumInset:"1.5em",border:{top:"1px solid #001e2e",left:"1px solid #001e2e",right:"1px solid #103e4e",bottom:"1px solid #103e4e"},background:"#3f3f3f",valueColor:"#ffffff"}),new Echo.Row({foreground:"#608e9e",children:[this._dataTransfer=new Echo.Label({layoutData:{alignment:"33%"}}),this._transferRate=new Echo.Label({layoutData:{alignment:"center",width:"33%"}}),this._timeRemaining=new Echo.Label({layoutData:{alignment:"right",width:"33%"}})]})]}),new Echo.Button({icon:this._r.i["Upload.Stop"],events:{action:Core.method(this,this._doStop)}})]})]});
},_doDetail:function(a){this._detailWindow=new WS.UploadMonitor.DetailWindow();this._contentPane.add(this._detailWindow);},_doStop:function(b){var a=new WS.Dialog(this._r.m["UploadProgrsss.StopConfirmDialog.Title"],null,this._r.m["UploadProgress.StopConfirmDialog.Message"],this._r.i["Dialog.Warning"],WS.Dialog.CONTROLS_YES_NO,Core.method(this,function(c){if(c.actionCommand=="yes"){this.fireEvent({type:"stop",source:this});}}));this.application.content.add(a);},updateProgress:function(c){this._itemsIndicator.set("text",c.currentItemIndex+"/"+c.totalItemCount);this._progressSlider.set("value",100*c.sentDataSize/c.totalDataSize);var a=c.transferRate;var b=c.timeRemaining;if(this._uploading){this._timeRemaining.set("text",WS.Util.formatTimeRemaining(b));this._transferRate.set("text",a>0?WS.Util.formatBytesSecond(a):"---");this._dataTransfer.set("text",WS.Util.formatBytes(c.sentDataSize)+"/"+WS.Util.formatBytes(c.totalDataSize));}if(this._detailWindow){this._detailWindow.update(c);}},updateState:function(a){if(this._uploading==a){return;
}this._uploading=a;if(a){this._titleLabel.set("text",this._r.m["UploadProgress.Title.Uploading"]);}else{this._timeRemaining.set("text",this._r.m["UploadProgress.Message.MediaScan"]);this._dataTransfer.set("text",null);this._transferRate.set("text",null);this._titleLabel.set("text",this._r.m["UploadProgress.Title.Storing"]);}}});WS.UploadMonitor.DetailWindow=Core.extend(Echo.WindowPane,{_descriptorMap:null,_uploadCount:0,_itemGrid:null,$construct:function(){this._descriptorMap={};this._r=WS.getResources();Echo.WindowPane.call(this,{width:500,height:500,insets:"5 10",styleName:"Default",title:this._r.m["UploadProgress.Window.Title"],modal:true,events:{close:Core.method(this,function(a){this.parent.remove(this);})},children:[this._itemGrid=new Echo.Grid({width:"100%",insets:2,size:2,columnWidth:["70%","30%"]})]});},dispose:function(){},update:function(k){if(k.uploads.length>this._uploadCount){this._updateUploads(k);}for(var f=0;f<k.uploads.length;++f){var d=k.uploads[f];for(var c=0;c<d.descriptors.length;
++c){var h=d.descriptors[c];var b=this._getName(h);var a=this._descriptorMap[b];if(a==null){continue;}if(h.uploadedSize<=0||h.fileSize<=0){a.progressSlider.set("value",0);}else{if(h.uploadedSize>=h.fileSize){a.progressSlider.set("value",100);}else{var g=100*h.uploadedSize/h.fileSize;a.progressSlider.set("value",g);}}}}},_getName:function(a){return a.id+":"+a.path;},_updateUploads:function(h){this._itemGrid.removeAll();this._uploadCount=h.uploads.length;for(var f=0;f<h.uploads.length;++f){var d=h.uploads[f];Core.Debug.consoleWrite("DATA:"+Core.Debug.toString(d.data));this._itemGrid.add(new Echo.Panel({layoutData:{columnSpan:Echo.Grid.SPAN_FILL,insets:"20px 0 0 0"},border:{top:"1px solid #afafaf",left:null,right:null,bottom:null},children:[new Echo.Label({text:this._r.m["UploadProgress.Window.DestinationPrompt"]+" "+d.data.storagePath,foreground:"#afafaf",font:{typeface:WS.Style.ROBOTO_LIGHT,size:"15pt"}})]}));for(var c=0;c<d.descriptors.length;++c){var g=d.descriptors[c];var b=this._getName(g);
var a={label:new Echo.Label({text:g.path}),progressSlider:new WS.Slider({border:{top:"1px solid #0f0f0f",left:"1px solid #0f0f0f",right:"1px solid #3f3f3f",bottom:"1px solid #3f3f3f"},background:"#2f2f2f",valueColor:"#33B5E5",value:50})};this._itemGrid.add(a.label);this._itemGrid.add(a.progressSlider);this._descriptorMap[b]=a;}}}});