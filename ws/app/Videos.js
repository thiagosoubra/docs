WS.Videos=Core.extend(WS.WorkspaceModule,{_videoPlayerWindow:null,_activeDisplay:null,$construct:function(){this._r=WS.getResources();this._processActionRef=Core.method(this,this._processAction);this.fileContributions=[new Extras.OptionModel("downloadvideos",this._r.m["Menu.DownloadVideos"],this._r.i["Menu.DownloadVideos"]),new Extras.SeparatorModel(),new Extras.OptionModel("delete",this._r.m["Menu.Delete"],this._r.i["Menu.Delete"])];this.viewContributions=[new Extras.OptionModel("refresh",this._r.m["Menu.Refresh"],this._r.i["Menu.Refresh"])];WS.WorkspaceModule.call(this,{children:[new Extras.ContextMenu({styleName:"Default",stateModel:new WS.FileBrowser.ContextMenuModel(this),model:new Extras.MenuModel(null,null,null,[new Extras.OptionModel("downloadvideos",this._r.m["Menu.DownloadVideos"],this._r.i["Menu.DownloadVideos"]),new Extras.SeparatorModel(),new Extras.OptionModel("delete",this._r.m["Menu.Delete"],this._r.i["Menu.Delete"]),new Extras.SeparatorModel(),new Extras.OptionModel("refresh",this._r.m["Menu.Refresh"],this._r.i["Menu.Refresh"])]),children:[this._contentArea=new Echo.ContentPane({})],events:{action:Core.method(this,function(a){this.doOperation(a.modelId);
})}})],events:{init:Core.method(this,function(a){this._syncVideo=new WS.Synchronize.Video(this.application.server);this._displayCameraRoll();})}});},activate:function(b){var e;b.sidePane.add(new Echo.ContentPane({background:"#afafaf",foreground:"#4f4f4f",children:[e=new Echo.Column({insets:"10 3 0 10"})]}));if(WS.mediaIndices.length>1){var a=[];var d=0;for(var c=0;c<WS.mediaIndices.length;++c){a[c]=WS.mediaIndices[c].displayName;if(this._syncVideo.mediaIndex==WS.mediaIndices[c].name){d=c;}}e.add(new Echo.Row({cellSpacing:"1ex",children:[new Echo.Label({text:this._r.m["StorageBase.Prompt"]}),new Echo.SelectField({items:a,selection:d,events:{action:Core.method(this,function(g){var f=WS.mediaIndices[g.source.get("selection")||0].name;this._syncVideo.mediaIndex=f;WS.pref.mediaIndex=f;WS.savePrefs();this._doRefresh();})}})]}));}if(WS.user.owner){e.add(new Echo.Grid({width:"100%",columnWidth:["50%","50%"],children:[new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Videos.CategoryCameraRoll"],text:this._r.m["Videos.CategoryCameraRoll"],events:{action:Core.method(this,this._displayCameraRoll)}})]}),new Echo.Panel({styleName:"ShadowLight",children:[new Echo.Button({styleName:"CategoryLight",icon:this._r.i["Videos.CategoryAll"],text:this._r.m["Videos.CategoryAll"],events:{action:Core.method(this,this._displayAll)}})]})]}));
}},_displayAll:function(){this._setActiveDisplay(new WS.Videos.Gallery(this._syncVideo,{all:true}));},_displayCameraRoll:function(){this._setActiveDisplay(new WS.Videos.Gallery(this._syncVideo,{camera:true}));},_doDeleteConfirm:function(){var d=this._activeDisplay.getSelectionQuery();if(!d){return;}var c=new Echo.Grid({size:2,insets:"1ex 2em",width:"100%"});for(var b=0;b<d.videoIds.length;++b){var e=this._r.i["Videos.DefaultThumbnail"];c.add(new Echo.Label({icon:e,text:"***",layoutData:{alignment:{horizontal:"center",vertical:"center"}}}));}var a=new WS.Workspace.DeleteConfirmDialog(c,Core.method(this,this._doDeleteSelection));this.application.content.add(a);},_doDeleteSelection:function(){var a=this._activeDisplay.getSelectionQuery();if(!a){return;}var b=Core.method(this,function(c){this._doRefresh();});this._syncVideo.deleteVideo(b,a.videoIds);},_doDownloadVideos:function(){var a=this._activeDisplay.getSelectionQuery();if(!a){return;}top.location=this._syncVideo.getDownloadUrl(a);},doOperation:function(a){switch(a){case"downloadvideos":this._doDownloadVideos();
break;case"delete":this._doDeleteConfirm();break;case"refresh":this._doRefresh();break;}},_doRefresh:function(){this._activeDisplay.refresh();},isOptionEnabled:function(a){if(a=="downloadvideos"){return this._activeDisplay&&this._activeDisplay.getSelectionQuery()!=null;}else{return true;}},_processAction:function(a){if(WS.pref.videoAuto||WS.pref.videoFlash||WS.pref.videoHtml5){this.application.displayVideo(a.video.contentType,this._syncVideo.getUrl(a.video),this._syncVideo.getDownloadUrl({videoIds:[a.video.id]}));}else{top.location=this._syncVideo.getDownloadUrl({videoIds:[a.video.id]});}},_setActiveDisplay:function(a){this._contentArea.removeAll();if(this._activeDisplay){this._activeDisplay.removeListener("action",this._processActionRef);}this._activeDisplay=a;this._activeDisplay.addListener("action",this._processActionRef);this._contentArea.add(this._activeDisplay);}});WS.Videos.Gallery=Core.extend(Echo.ContentPane,{$construct:function(a,b){this._r=WS.getResources();this._syncVideo=a;
this._query=b;this._model=new WS.Videos.GalleryModel(this._syncVideo,this._query);this._viewer=new Extras.FlowViewer({background:"#2f2f2f",backgroundImage:{url:"image/fill/PhotoGrayGradient.png",x:0,repeat:"y"},foreground:"#dfdfdf",model:this._model,renderer:new WS.Videos.GalleryRenderer(this._syncVideo,WS.Style.videoGalleryRendererStyle),events:{action:Core.method(this,function(d){var c=this._model.get(d.index);if(!c){return;}this.fireEvent({source:this,type:"action",video:c});})}});Echo.ContentPane.call(this,{children:[this._viewer]});},getSelectionQuery:function(){var b=this._viewer.get("selection");var d=[];for(var a in b){if(b[a]){var c=this._model.get(a);if(c){d.push(c.id);}}}if(d.length===0){return null;}return{videoIds:d};},refresh:function(){this._model=new WS.Videos.GalleryModel(this._syncVideo,this._query);this._viewer.set("selection",null);this._viewer.set("model",this._model);}});WS.Videos.GalleryModel=Core.extend(WS.CacheViewerModel,{$construct:function(a,b){WS.CacheViewerModel.call(this);
this._syncVideo=a;this._query=b;},fetchImpl:function(b,a){this._syncVideo.listVideos(Core.method(this,this._processVideos),this._query,b,a);},_processVideos:function(a){this.cacheStore(a.startIndex,a.endIndex,a.videos,a.count);}});WS.Videos.GalleryRenderer=Core.extend(Extras.Sync.FlowViewer.Renderer,{$load:function(){var a=document.createElement("div");a.appendChild(document.createTextNode("Test Height"));this._textHeight=new Core.Web.Measure.Bounds(a).height;},_loadingDiv:null,$construct:function(b,c){this._processImageLoadRef=Core.method(this,this._processImageLoad);this._r=WS.getResources();this._syncVideo=b;this._styleData=c=c||{};this._border=c.border;this._selectedBorder=c.selectedBorder;this._borderInsetsPx=Echo.Sync.Insets.toPixels(c.border?c.border.contentInsets:null);this._borderWidth=this._borderInsetsPx.left+this._borderInsetsPx.right;this._borderHeight=this._borderInsetsPx.top+this._borderInsetsPx.bottom;this._imageHeight=192;this._imageWidth=192;this._ar=this._imageWidth/this._imageHeight;
this._contentWidth=this._imageWidth;this._cellWidth=this._contentWidth+this._borderWidth;this._contentHeight=this._imageHeight+WS.Videos.GalleryRenderer._textHeight;this._cellHeight=this._contentHeight+this._borderHeight;this._loadingDiv=document.createElement("div");this._loadingDiv.style.width=this._cellWidth+"px";this._loadingDiv.style.height=this._cellHeight+"px";var a=document.createElement("img");a.style.paddingLeft=((this._cellWidth-96)/2)+"px";a.style.paddingTop=((this._cellHeight-96)/2)+"px";a.src=this._r.i["FlowViewer.LoadingIcon"];this._loadingDiv.appendChild(a);},dispose:function(e,c,d,b,a){},_fitImage:function(c){var d=parseInt(c.width,10);var a=parseInt(c.height,10);var b=d/a;if(b>this._ar){d=this._imageWidth;a=Math.floor(this._imageWidth/b);}else{a=this._imageHeight;d=Math.floor(this._imageHeight*b);}c.width=d;c.height=a;c.style.paddingTop=((this._imageHeight-a)/2)+"px";},getCellSize:function(){return{width:this._cellWidth,height:this._cellHeight};},_processImageLoad:function(b){var a=Core.Web.DOM.getEventTarget(b);
this._fitImage(a);},render:function(l,e,i,c,d){if(!e){c.appendChild(this._loadingDiv.cloneNode(true));return;}var f=d&&d.selected;var a=document.createElement("div");a.style.cssText="width:"+this._cellWidth+"px;"+"height:"+this._cellHeight+"px;";var k=document.createElement("div");k.style.cssText="width:"+this._contentWidth+"px;height:"+this._contentHeight+"px;overflow:hidden;";Echo.Sync.Color.render(this._styleData.background,k,"backgroundColor");Echo.Sync.Color.render(this._styleData.foreground,k,"color");var m=document.createElement("div");m.style.cssText="overflow:hidden;text-align:center;height:"+this._imageHeight+"px";var g=document.createElement("img");if(this._syncVideo.thumbSupport){g.src=this._syncVideo.getThumbUrl(e);if(g.complete){this._fitImage(g);}else{Core.Web.DOM.addEventListener(g,"load",this._processImageLoadRef,false);}}else{g.style.paddingTop=((this._imageHeight-96)/2)+"px";g.src=this._r.i["Videos.DefaultThumbnail"];}m.appendChild(g);k.appendChild(m);var b=document.createElement("div");
b.style.cssText="overflow:hidden;height:"+(this._contentHeight-this._imageHeight)+"px";Echo.Sync.Color.render(this._styleData.titleBackground,b,"backgroundColor");Echo.Sync.Color.render(this._styleData.titleForeground,b,"color");k.appendChild(b);var j=document.createElement("div");j.style.cssText="white-space:nowrap;text-align:center;";j.appendChild(document.createTextNode(e.title||"\u00a0"));b.appendChild(j);var h=Echo.Sync.FillImageBorder.renderContainer(f?this._selectedBorder:this._border,{child:k,absolute:false});a.appendChild(h);c.appendChild(a);Echo.Sync.FillImageBorder.renderContainerDisplay(h);}});