Echo.Client=Core.extend({$static:{DEFAULT_CONFIGURATION:{"StopError.Message":"This application has been stopped due to an error.","WaitIndicator.Text":"Please wait...","Action.Continue":"Continue","Action.Restart":"Restart Application"},STYLE_CRITICAL:0,STYLE_MESSAGE:1,_activeClients:[],_globalWindowResizeListener:function(b){for(var a=0;a<Echo.Client._activeClients.length;++a){Echo.Client._activeClients[a]._windowResizeListener(b);}},windowId:null},$load:function(){Core.Web.DOM.addEventListener(window,"resize",this._globalWindowResizeListener,false);var b=/EchoWindowId=([0-9a-f]*\.[0-9a-f]*);/i;var a=b.exec(window.name||"");this.windowId=a&&a[1];if(!this.windowId){this.windowId=new Date().getTime().toString(16)+"."+parseInt(Math.random()*4294967296,10).toString(16);window.name=(window.name||"")+";EchoWindowId="+this.windowId+";";}},configuration:null,designMode:false,domainElement:null,application:null,_lastInputRestrictionId:0,_inputRestrictionCount:0,_inputRestrictionListeners:null,_inputRescriptionMap:null,_keyFocusedComponentId:null,_lastKeyCode:null,_processKeyRef:null,_waitIndicatorActive:false,_processApplicationFocusRef:null,parent:null,_waitIndicator:null,_preWaitIndicatorDelay:500,_waitIndicatorRunnable:null,_failed:false,$construct:function(){this.configuration={};
for(var a in Echo.Client.DEFAULT_CONFIGURATION){this.configuration[a]=Echo.Client.DEFAULT_CONFIGURATION[a];}this._inputRestrictionMap={};this._processKeyRef=Core.method(this,this._processKey);this._processApplicationFocusRef=Core.method(this,this._processApplicationFocus);this._waitIndicator=new Echo.Client.DefaultWaitIndicator();this._waitIndicatorRunnable=new Core.Web.Scheduler.MethodRunnable(Core.method(this,this._waitIndicatorActivate),this._preWaitIndicatorDelay,false);},$abstract:true,$virtual:{getResourceUrl:function(a,b){if(this.parent){return this.parent.getResourceUrl(a,b);}else{return null;}},verifyInput:function(a){if(this._inputRestrictionCount!==0){return false;}if(a){return a.isActive();}else{return this.application.isActive();}},dispose:function(){this.configure(null,null);this._setWaitVisible(false);}},addElement:function(a){Core.Web.Event.add(a,"keypress",this._processKeyRef,false);Core.Web.Event.add(a,"keydown",this._processKeyRef,false);Core.Web.Event.add(a,"keyup",this._processKeyRef,false);
},configure:function(a,b){if(this.application){Core.Arrays.remove(Echo.Client._activeClients,this);this.removeElement(this.domainElement);this.application.removeListener("focus",this._processApplicationFocusRef);this.application.doDispose();this.application.client=null;}this.application=a;this.domainElement=b;if(this.application){this.application.client=this;this.application.doInit();this.application.addListener("focus",this._processApplicationFocusRef);this.addElement(this.domainElement);Echo.Client._activeClients.push(this);}},createInputRestriction:function(){this._setWaitVisible(true);var a=(++this._lastInputRestrictionId).toString();++this._inputRestrictionCount;this._inputRestrictionMap[a]=true;return a;},displayError:function(n,o,i,h,g,b){n=n||document.body;var f=this.createInputRestriction();this._setWaitVisible(false);var k=document.createElement("div");k.style.cssText="position:absolute;z-index:32766;width:100%;height:100%;background-color:#000000;opacity:0.75";if(Core.Web.Env.PROPRIETARY_IE_OPACITY_FILTER_REQUIRED){k.style.filter="alpha(opacity=75)";
}n.appendChild(k);var a=document.createElement("div");a.style.cssText="position:absolute;z-index:32767;width:100%;height:100%;overflow:hidden;";n.appendChild(a);var e=document.createElement("div");e.style.cssText="color:#ffffff;padding:20px 40px 0px;"+(b===Echo.Client.STYLE_MESSAGE?"border-bottom:4px solid #1f1faf;background-color:#1f1f5f":"border-bottom:4px solid #af1f1f;background-color:#5f1f1f");if(o){var m=document.createElement("div");m.style.cssText="font-weight: bold; margin-bottom:20px;";m.appendChild(document.createTextNode(o));e.appendChild(m);}if(i){var l=document.createElement("div");l.style.cssText="max-height:10em;overflow:auto;margin-bottom:20px;";l.appendChild(document.createTextNode(i));e.appendChild(l);}a.appendChild(e);if(h){var d=document.createElement("div");d.tabIndex="0";d.style.cssText="margin-bottom:20px;cursor:pointer;font-weight:bold;padding:2px 10px;"+(b===Echo.Client.STYLE_MESSAGE?"border: 1px outset #2f2faf;background-color:#2f2faf;":"border: 1px outset #af2f2f;background-color:#af2f2f;");
d.appendChild(document.createTextNode(h));e.appendChild(d);var c=Core.method(this,function(p){if(p.type!="keypress"||p.keyCode==13){try{Core.Web.DOM.removeEventListener(d,"click",c,false);Core.Web.DOM.removeEventListener(d,"keypress",c,false);a.parentNode.removeChild(a);k.parentNode.removeChild(k);this.removeInputRestriction(f);}finally{if(g){g();}}}});Core.Web.DOM.addEventListener(d,"click",c,false);Core.Web.DOM.addEventListener(d,"keypress",c,false);Core.Web.DOM.focusElement(d);}var j=document.createElement("div");j.style.cssText="position:absolute;top:2px;right:8px;color:#ffffff;font-weight:bold;cursor:pointer;";j.appendChild(document.createTextNode("x"));Core.Web.DOM.addEventListener(j,"click",Core.method(this,function(){k.parentNode.removeChild(k);a.parentNode.removeChild(a);}),false);a.appendChild(j);},exec:function(b,c){var a=this.createInputRestriction();Core.Web.Library.exec(b,Core.method(this,function(d){if(d&&!d.success){this.fail("Cannot install library: "+d.url+" Exception: "+d.ex);
return;}this.removeInputRestriction(a);c();}));},fail:function(b){if(this._failed){return;}this._failed=true;var a=this.domainElement;try{this.dispose();}finally{if(this.configuration["StopError.URI"]){window.location.href=this.configuration["StopError.URI"];}else{this.displayError(a,this.configuration["StopError.Message"],b,this.configuration["Action.Restart"],function(){window.location.reload();});}}},forceRedraw:function(){if(this.parent){this.parent.forceRedraw();}else{if(Core.Web.Env.QUIRK_IE_BLANK_SCREEN){if(this.domainElement&&this.domainElement.offsetHeight===0){var a=document.documentElement.style.display||"";document.documentElement.style.display="none";document.documentElement.style.display=a;}}}},getWaitIndicator:function(){return this._waitIndicator;},_processApplicationFocus:function(b){var a=this.application.getFocusedComponent();if(a&&a.peer&&a.peer.renderFocus){a.peer.renderFocus();}},_processKey:function(c){var a=c.type=="keyup",b=c.type=="keypress",g=this.application.getFocusedComponent(),f=true,d=null,i;
if(b){i=this._lastKeyCode;}else{i=this._lastKeyCode=Core.Web.Key.translateKeyCode(c.keyCode);}if(!a){if(i==8){var h=c.target.nodeName?c.target.nodeName.toLowerCase():null;if(h!="input"&&h!="textarea"){Core.Web.DOM.preventEventDefault(c);}}else{if(!b&&i==9){this.application.focusNext(c.shiftKey);Core.Web.DOM.preventEventDefault(c);}}if(b&&Core.Web.Env.QUIRK_KEY_PRESS_FIRED_FOR_SPECIAL_KEYS&&!c.charCode){return true;}}if(!g){return true;}if(a||b){if(this._keyFocusedComponentId!=g.renderId){return true;}}else{this._keyFocusedComponentId=g.renderId;}var j=b?"clientKeyPress":(a?"clientKeyUp":"clientKeyDown");while(g&&f){if(g.peer&&g.peer[j]){if(!d){d={type:c.type,source:this,keyCode:i,domEvent:c};if(b){d.charCode=Core.Web.Env.QUIRK_KEY_CODE_IS_CHAR_CODE?c.keyCode:c.charCode;}}f=g.peer[j](d);}g=g.parent;}return true;},processUpdates:function(){var b=null;try{b=this.createInputRestriction();Echo.Render.processUpdates(this);this.removeInputRestriction(b);this.forceRedraw();}catch(a){if(a.lineNumber){Core.Debug.consoleWrite("Reported Line #: "+a.lineNumber);
Core.Debug.consoleWrite("Evaluated Line #: "+(a.lineNumber-Core.Web.Library.evalLine)+" (if evaluated script)");}if(a.stack){Core.Debug.consoleWrite("Exception: "+a+", Stack Trace: "+a.stack);}this.fail("Exception during Client.processUpdates(): "+a.message);throw (a);}},registerRestrictionListener:function(b,a){if(!this._inputRestrictionListeners){this._inputRestrictionListeners={};}this._inputRestrictionListeners[b.renderId]=a;},removeInputRestriction:function(c){if(this._inputRestrictionMap[c]===undefined){return;}delete this._inputRestrictionMap[c];--this._inputRestrictionCount;if(this._inputRestrictionCount===0){this._setWaitVisible(false);if(this._inputRestrictionListeners){var b=this._inputRestrictionListeners;this._inputRestrictionListeners=null;for(var a in b){b[a]();}}}},_setWaitVisible:function(a){if(a){if(!this._waitIndicatorActive){this._waitIndicatorActive=true;Core.Web.Scheduler.add(this._waitIndicatorRunnable);}}else{if(this._waitIndicatorActive){this._waitIndicatorActive=false;
Core.Web.Scheduler.remove(this._waitIndicatorRunnable);this._waitIndicator.deactivate(this);this.forceRedraw();}}},setWaitIndicator:function(a){if(this._waitIndicator){this._setWaitVisible(false);if(this._waitIndicator.dispose){this._waitIndicator.dispose(this);}}this._waitIndicator=a;},removeElement:function(a){Core.Web.Event.remove(a,"keypress",this._processKeyRef,false);Core.Web.Event.remove(a,"keydown",this._processKeyRef,false);Core.Web.Event.remove(a,"keyup",this._processKeyRef,false);},_waitIndicatorActivate:function(){this._waitIndicator.activate(this);},_windowResizeListener:function(a){if(this.application.rootComponent.peer){Echo.Render.notifyResize(this.application.rootComponent);}}});Echo.Client.Timer=Core.extend({_times:null,_labels:null,$construct:function(){this._times=[new Date().getTime()];this._labels=["Start"];},mark:function(a){this._times.push(new Date().getTime());this._labels.push(a);},toString:function(){var a="";for(var b=1;b<this._times.length;++b){var c=this._times[b]-this._times[b-1];
a+=this._labels[b]+":"+c+" ";}a+="TOT:"+(this._times[this._times.length-1]-this._times[0])+"ms";return a;}});Echo.Client.WaitIndicator=Core.extend({$abstract:{activate:function(a){},deactivate:function(a){}},$virtual:{dispose:null}});Echo.Client.DefaultWaitIndicator=Core.extend(Echo.Client.WaitIndicator,{$construct:function(){this._divElement=document.createElement("div");this._divElement.style.cssText="display: none;z-index:32000;position:absolute;top:30px;right:30px;"+"width:200px;padding:20px;border:1px outset #abcdef;background-color:#abcdef;color:#000000;text-align:center;";this._textNode=document.createTextNode("");this._divElement.appendChild(this._textNode);this._fadeRunnable=new Core.Web.Scheduler.MethodRunnable(Core.method(this,this._tick),50,true);document.body.appendChild(this._divElement);},activate:function(a){if(a.configuration["WaitIndicator.Background"]){this._divElement.style.backgroundColor=a.configuration["WaitIndicator.Background"];this._divElement.style.borderColor=a.configuration["WaitIndicator.Background"];
}if(a.configuration["WaitIndicator.Foreground"]){this._divElement.style.color=a.configuration["WaitIndicator.Foreground"];}this._textNode.nodeValue=a.configuration["WaitIndicator.Text"];this._divElement.style.display="block";Core.Web.Scheduler.add(this._fadeRunnable);this._opacity=0;},deactivate:function(a){this._divElement.style.display="none";Core.Web.Scheduler.remove(this._fadeRunnable);},dispose:function(a){if(this._divElement&&this._divElement.parentNode){this._divElement.parentNode.removeChild(this._divElement);}this._divElement=null;this._textNode=null;},_tick:function(){++this._opacity;var a=1-(Math.abs((this._opacity%40)-20)/30);if(!Core.Web.Env.PROPRIETARY_IE_OPACITY_FILTER_REQUIRED){this._divElement.style.opacity=a;}}});