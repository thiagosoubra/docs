Echo.Sync.Grid=Core.extend(Echo.Render.ComponentSync,{$static:{_createPrototypeTable:function(){var c=document.createElement("div");var a=document.createElement("table");a.style.outlineStyle="none";a.tabIndex="-1";a.style.borderCollapse="collapse";var b=document.createElement("colgroup");a.appendChild(b);a.appendChild(document.createElement("tbody"));c.appendChild(a);return c;},Processor:Core.extend({$static:{Cell:Core.extend({xSpan:null,ySpan:null,index:null,component:null,$construct:function(c,b,d,a){this.component=c;this.index=b;this.xSpan=d;this.ySpan=a;}})},cellArrays:null,grid:null,gridXSize:null,gridYSize:null,xExtents:null,yExtents:null,horizontalOrientation:null,$construct:function(b){this.grid=b;this.cellArrays=[];this.horizontalOrientation=b.render("orientation")!=Echo.Grid.ORIENTATION_VERTICAL;var a=this.createCells();if(a==null){this.gridXSize=0;this.gridYSize=0;return;}this.renderCellMatrix(a);this.calculateExtents();this.reduceY();this.reduceX();},addExtents:function(e,c,d){var f=Echo.Sync.Extent.isPercent(e),g=Echo.Sync.Extent.isPercent(c);
if(f||g){if(f&&g){return(parseFloat(e)+parseFloat(c))+"%";}else{return f?e:c;}}else{return Echo.Sync.Extent.toPixels(e)+Echo.Sync.Extent.toPixels(c);}},calculateExtents:function(){var c,b=this.horizontalOrientation?"columnWidth":"rowHeight",a=this.horizontalOrientation?"rowHeight":"columnWidth";this.xExtents=[];for(c=0;c<this.gridXSize;++c){this.xExtents.push(this.grid.renderIndex(b,c));}this.yExtents=[];for(c=0;c<this.gridYSize;++c){this.yExtents.push(this.grid.renderIndex(a,c));}},createCells:function(){var b=this.grid.getComponentCount();if(b===0){return null;}var c=[];for(var d=0;d<b;++d){var g=this.grid.getComponent(d);var f=g.render("layoutData");if(f){var e=this.horizontalOrientation?f.columnSpan:f.rowSpan;var a=this.horizontalOrientation?f.rowSpan:f.columnSpan;c.push(new Echo.Sync.Grid.Processor.Cell(g,d,e?e:1,a?a:1));}else{c.push(new Echo.Sync.Grid.Processor.Cell(g,d,1,1));}}return c;},_getCellArray:function(a){while(a>=this.cellArrays.length){this.cellArrays.push([]);}return this.cellArrays[a];
},getColumnCount:function(){return this.horizontalOrientation?this.gridXSize:this.gridYSize;},getCell:function(a,b){if(this.horizontalOrientation){return this.cellArrays[b][a];}else{return this.cellArrays[a][b];}},getRowCount:function(){return this.horizontalOrientation?this.gridYSize:this.gridXSize;},reduceX:function(){var c=[],b=1,g,e=this.cellArrays[0].length;while(b<e){g=0;var f=true;while(g<this.cellArrays.length){if(this.cellArrays[g][b]!=this.cellArrays[g][b-1]){f=false;break;}++g;}if(f){c[b]=true;}++b;}if(c.length===0){return;}for(var a=this.gridXSize-1;a>=1;--a){if(!c[a]){continue;}for(g=0;g<this.gridYSize;++g){if(g===0||this.cellArrays[g][a-1]!=this.cellArrays[g-1][a-1]){if(this.cellArrays[g][a-1]!=null){--this.cellArrays[g][a-1].xSpan;}}this.cellArrays[g].splice(a,1);}var d=this.xExtents.splice(a,1)[0];if(d){this.xExtents[a-1]=this.addExtents(this.xExtents[a-1],d,this.horizontalOrientation?true:false);}--this.gridXSize;}},reduceY:function(){var h=[],e=1,g,j=this.cellArrays.length,i,c=this.cellArrays[0];
while(e<j){i=c;c=this.cellArrays[e];g=0;var f=true;while(g<c.length){if(c[g]!=i[g]){f=false;break;}++g;}if(f){h[e]=true;}++e;}if(h.length===0){return;}for(var d=this.gridYSize-1;d>=0;--d){if(!h[d]){continue;}var b=this.cellArrays[d-1];for(g=0;g<this.gridXSize;++g){if(g===0||b[g]!=b[g-1]){if(b[g]!=null){--b[g].ySpan;}}}this.cellArrays.splice(d,1);var a=this.yExtents.splice(d,1)[0];if(a){this.yExtents[d-1]=this.addExtents(this.yExtents[d-1],a,this.horizontalOrientation?false:true);}--this.gridYSize;}},renderCellMatrix:function(i){this.gridXSize=parseInt(this.grid.render("size",2),10);var g=0,f=0,b,e,h=this._getCellArray(f);for(var c=0;c<i.length;++c){if(i[c].xSpan==Echo.Grid.SPAN_FILL||i[c].xSpan>this.gridXSize-g){i[c].xSpan=this.gridXSize-g;}if(i[c].xSpan<1){i[c].xSpan=1;}if(i[c].ySpan<1){i[c].ySpan=1;}if(i[c].xSpan!=1||i[c].ySpan!=1){for(b=1;b<i[c].xSpan;++b){if(h[g+b]!=null){i[c].xSpan=b;break;}}for(e=0;e<i[c].ySpan;++e){var d=this._getCellArray(f+e);for(b=0;b<i[c].xSpan;++b){d[g+b]=i[c];
}}}h[g]=i[c];if(c<i.length-1){var a=false;while(!a){if(g<this.gridXSize-1){++g;}else{g=0;++f;h=this._getCellArray(f);}a=h[g]==null;}}}this.gridYSize=this.cellArrays.length;}})},$load:function(){this._prototypeTable=this._createPrototypeTable();Echo.Render.registerPeer("Grid",this);},_columnCount:null,_rowCount:null,clientKeyDown:function(f){var a,c,d,b;switch(f.keyCode){case 37:case 39:a=this.component.getRenderLayoutDirection().isLeftToRight()?f.keyCode==37:f.keyCode==39;c=this.client.application.getFocusedComponent();if(c&&c.peer&&c.peer.getFocusFlags){d=c.peer.getFocusFlags();if((a&&d&Echo.Render.ComponentSync.FOCUS_PERMIT_ARROW_LEFT)||(!a&&d&Echo.Render.ComponentSync.FOCUS_PERMIT_ARROW_RIGHT)){b=this.client.application.focusManager.findInParent(this.component,a);if(b){this.client.application.setFocusedComponent(b);Core.Web.DOM.preventEventDefault(f.domEvent);return false;}}}break;case 38:case 40:a=f.keyCode==38;c=this.client.application.getFocusedComponent();if(c&&c.peer&&c.peer.getFocusFlags){d=c.peer.getFocusFlags();
if((a&&d&Echo.Render.ComponentSync.FOCUS_PERMIT_ARROW_UP)||(!a&&d&Echo.Render.ComponentSync.FOCUS_PERMIT_ARROW_DOWN)){b=this.client.application.focusManager.findInParent(this.component,a,this._columnCount);if(b){this.client.application.setFocusedComponent(b);Core.Web.DOM.preventEventDefault(f.domEvent);return false;}}}break;}return true;},renderAdd:function(o,j){var g=new Echo.Sync.Grid.Processor(this.component),m=Echo.Sync.Insets.toCssValue(this.component.render("insets",0)),f,l=this.component.render("border",""),u=this.component.render("width"),r=this.component.render("height"),n,z;f=Echo.Sync.Insets.toPixels(m);this._columnCount=g.getColumnCount();this._rowCount=g.getRowCount();this._div=Echo.Sync.Grid._prototypeTable.cloneNode(true);this._div.id=this.component.renderId;var y=this._div.firstChild;Echo.Sync.renderComponentDefaults(this.component,y);Echo.Sync.Border.render(l,y);y.style.padding=m;if(u&&Core.Web.Env.QUIRK_IE_TABLE_PERCENT_WIDTH_SCROLLBAR_ERROR&&Echo.Sync.Extent.isPercent(u)){this._div.style.zoom=1;
}if(u){if(Echo.Sync.Extent.isPercent(u)){y.style.width=u;}else{y.style.width=Echo.Sync.Extent.toCssValue(u,true);}}if(r){if(Echo.Sync.Extent.isPercent(r)){y.style.height=r;}else{y.style.height=Echo.Sync.Extent.toCssValue(r,false);}}var t=y.firstChild;for(z=0;z<this._columnCount;++z){var k=document.createElement("col");u=g.xExtents[z];if(u!=null){if(Echo.Sync.Extent.isPercent(u)){k.style.width=u.toString();}else{var x=Echo.Sync.Extent.toPixels(u,true);if(Core.Web.Env.QUIRK_TABLE_CELL_WIDTH_EXCLUDES_PADDING){x-=f.left+f.right;if(x<0){x=0;}}k.style.width=x+"px";}}t.appendChild(k);}var b=t.nextSibling;var q=parseInt(this.component.render("size",2),10);var c;var e={};var a,s;if(g.horizontalOrientation){a="colSpan";s="rowSpan";}else{a="rowSpan";s="colSpan";}var w=document.createElement("td");Echo.Sync.Border.render(l,w);w.style.padding=m;for(var p=0;p<this._rowCount;++p){c=document.createElement("tr");r=g.yExtents[p];if(r){c.style.height=Echo.Sync.Extent.toCssValue(r,false);}b.appendChild(c);
for(z=0;z<this._columnCount;++z){var d=g.getCell(z,p);if(d==null){n=document.createElement("td");c.appendChild(n);continue;}if(e[d.component.renderId]){continue;}e[d.component.renderId]=true;n=w.cloneNode(false);if(d.xSpan>1){n.setAttribute(a,d.xSpan);}if(d.ySpan>1){n.setAttribute(s,d.ySpan);}var v=d.component.render("layoutData");if(v){var i=g.xExtents[z];if(Core.Web.Env.QUIRK_TABLE_CELL_WIDTH_EXCLUDES_PADDING&&i&&!Echo.Sync.Extent.isPercent(i)){var h=Echo.Sync.Insets.toPixels(v.insets);if(f.left+f.right<h.left+h.right){n.style.width=(Echo.Sync.Extent.toPixels(i)-(h.left+h.right))+"px";}}Echo.Sync.Insets.render(v.insets,n,"padding");Echo.Sync.Alignment.render(v.alignment,n,true,this.component);Echo.Sync.FillImage.render(v.backgroundImage,n);Echo.Sync.Color.render(v.background,n,"backgroundColor");}Echo.Render.renderComponentAdd(o,d.component,n);c.appendChild(n);}}j.appendChild(this._div);},renderDispose:function(a){this._div=null;},renderUpdate:function(c){var a=this._div;var b=a.parentNode;
Echo.Render.renderComponentDispose(c,c.parent);b.removeChild(a);this.renderAdd(c,b);return true;}});