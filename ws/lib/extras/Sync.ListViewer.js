Extras.Sync.ListViewer=Core.extend(Echo.Render.ComponentSync,{$load:function(){Echo.Render.registerPeer("Extras.ListViewer",this);},_columnsRendered:false,_cellHeight:null,_borderHeight:0,_columnWidthPx:null,_columnDivs:null,_protoCell:null,_div:null,_listDiv:null,_renderedStartIndex:null,_renderedEndIndex:null,_renderedPosition:0,_position:0,$construct:function(){this._updateListenerRef=Core.method(this,this._updateListener);},_calculateCellHeight:function(){var d=document.createElement("div");Echo.Sync.Font.render(this.component.render("headerFont"),d);d.appendChild(document.createTextNode("Test Height"));this._cellInnerHeight=new Core.Web.Measure.Bounds(d).height;var c=this.component.render("border");var a=Echo.Sync.Insets.toPixels(this.component.render("insets"));this._borderHeight=Echo.Sync.Border.getPixelSize(c,"top")+Echo.Sync.Border.getPixelSize(c,"bottom");var b=Echo.Sync.Insets.toPixels(this.component.render("headerInsets"));this._cellHeight=this._cellInnerHeight+this._borderHeight+a.top+a.bottom;
this._headerCellHeight=this._columnNames?this._cellInnerHeight+b.top+b.bottom:0;},_calculateColumnWidths:function(){var b=0,c=this._listBounds.width;this._columnWidthPx=[];var a=0;var d=this.component.render("columnWidth",["100%"]);for(b=0;b<d.length;++b){if(Echo.Sync.Extent.isPercent(d[b])){a+=parseInt(d[b],10);}else{this._columnWidthPx[b]=Echo.Sync.Extent.toPixels(d[b]);c-=this._columnWidthPx[b];}}var e=c;for(b=0;b<d.length;++b){if(Echo.Sync.Extent.isPercent(d[b])){this._columnWidthPx[b]=Math.floor(e*parseInt(d[b],10)/100);c-=this._columnWidthPx[b];}}this._columnWidthPx[this._columnWidthPx.length-1]+=c;},_clearContent:function(){this._columnsRendered=false;while(this._listDiv.firstChild){this._listDiv.removeChild(this._listDiv.firstChild);}if(this._columnNames){while(this._headerDiv.firstChild){this._headerDiv.removeChild(this._headerDiv.firstChild);}}},_createProtoCell:function(){this._protoCell=document.createElement("div");this._protoCell.style.cssText="overflow:hidden;white-space:nowrap;";
Echo.Sync.Insets.render(this.component.render("insets"),this._protoCell,"padding");this._protoCell.style.height=(this._cellInnerHeight)+"px";Echo.Sync.Border.render(this.component.render("border"),this._protoCell);},_getCellDiv:function(b,c){if(c<this._renderedStartIndex||c>=this._renderedEndIndex){return null;}var a=this._columnDivs[b].firstChild;return a.childNodes[c-this._renderedStartIndex];},_getIndexFromNode:function(d){var a,e;var b;var c;b=d;while(b&&b.parentNode!==this._listDiv){b=b.parentNode;}if(!b){return -1;}c=b.firstChild;while(d&&d.parentNode!==c){d=d.parentNode;}if(!d){return -1;}b=c.firstChild;e=0;while(b){if(b===d){return e+this._renderedStartIndex;}b=b.nextSibling;++e;}return -1;},_processRolloverEnter:function(b){if(!this.client||!this.client.verifyInput(this.component)){return;}var a=this._getIndexFromNode(b.target);this._setHighlight(a,true);},_processRolloverExit:function(b){var a=this._getIndexFromNode(b.target);this._setHighlight(a,false);},_processClick:function(g,f){if(!this.client||!this.client.verifyInput(this.component)){return;
}var c=this._getIndexFromNode(g.target);if(c===-1){return;}if(!f&&g.button===2){f=true;}if(g.ctrlKey||g.metaKey||g.altKey){var d=this.component.get("selection")||{};if(!f&&d[c]){delete d[c];}else{d[c]=true;}this.component.set("selection",null,true);this.component.set("selection",d,true);this._setHighlight(c,true);}else{var b=this.component.get("selection")||{};if(!f||!b[c]){d={};d[c]=true;this.component.set("selection",d,true);for(var a in b){if(a!==c){this._setHighlight(a,false);}}this._setHighlight(c,true);}}},_processContextMenu:function(a){this._processClick(a,true);return true;},_processDoubleClick:function(a){if(!this.client||!this.client.verifyInput(this.component)){return;}var b=this._getIndexFromNode(a.target);if(b!==-1){this.component.doAction(b);}},_processScroll:function(a){this._setPosition(a.row);},renderAdd:function(b,a){this._columnsRendered=false;this._columnNames=this.component.render("columnName");this._model=this.component.get("model")||new Extras.Viewer.NullModel();
this._model.addUpdateListener(this._updateListenerRef);this._renderer=this.component.get("renderer")||new Extras.Sync.ListViewer.ColumnRenderer();this._calculateCellHeight();this._div=document.createElement("div");this._div.style.cssText="position:absolute;left:0;top:0;right:0;bottom:0;";if(this._columnNames){this._headerDiv=document.createElement("div");this._headerDiv.style.cssText="position:absolute;left:0;top:0;right:0;overflow:hidden;";this._headerDiv.style.height=this._headerCellHeight+"px";Echo.Sync.Color.render(this.component.render("headerBackground"),this._headerDiv,"backgroundColor");Echo.Sync.Color.render(this.component.render("headerForeground"),this._headerDiv,"color");Echo.Sync.Font.render(this.component.render("headerFont"),this._headerDiv);this._div.appendChild(this._headerDiv);}this._containerDiv=document.createElement("div");this._containerDiv.style.cssText="position:absolute;left:0;right:0;bottom:0;";this._containerDiv.style.top=this._headerCellHeight+"px";this._div.appendChild(this._containerDiv);
this._scrollContainer=new Extras.Sync.Viewer.ScrollContainer(this.client,this.component,this._model.size(),this._cellHeight);this._scrollContainer.onScroll=Core.method(this,this._processScroll);this._containerDiv.appendChild(this._scrollContainer.rootElement);this._listDiv=document.createElement("div");this._listDiv.style.cssText="position:absolute;left:0;top:0;bottom:0;right:0;cursor:pointer;";Echo.Sync.Color.renderFB(this.component,this._listDiv);Echo.Sync.FillImage.render(this.component.render("backgroundImage"),this._listDiv);this._scrollContainer.contentElement.appendChild(this._listDiv);a.appendChild(this._div);this._createProtoCell();Core.Web.Event.add(this._div,"click",Core.method(this,this._processClick),false);Core.Web.Event.add(this._div,"contextmenu",Core.method(this,this._processContextMenu),false);Core.Web.Event.add(this._div,"dblclick",Core.method(this,this._processDoubleClick),false);if(this.component.render("rolloverEnabled")){Core.Web.Event.add(this._div,"mouseover",Core.method(this,this._processRolloverEnter),false);
Core.Web.Event.add(this._div,"mouseout",Core.method(this,this._processRolloverExit),false);}Core.Web.Event.Selection.disable(this._div);},_renderHighlight:function(f,h,j){var g=this.component.get("selection")||{};var b=g[h];var d=b?"selection":"rollover";var a,e;if(j||b){a=this.component.render(d+"Background");e=this.component.render(d+"Foreground");}for(var c=0;c<f.length;++c){Echo.Sync.Color.renderClear(a,f[c],"backgroundColor");Echo.Sync.Color.renderClear(e,f[c],"color");}},_renderColumns:function(){if(this._columnsRendered){return;}this._calculateColumnWidths();this._headerColumnDivs=[];this._columnDivs=[];var a=0;for(var b=0;b<this._columnWidthPx.length;++b){var c=Math.max(0,this._columnWidthPx[b]);if(this._columnNames&&this._columnNames[b]){this._headerColumnDivs[b]=document.createElement("div");this._headerColumnDivs[b].style.cssText="position:absolute;top:0;overflow:hidden;";this._headerColumnDivs[b].style.width=c+"px";this._headerColumnDivs[b].style.left=a+"px";Echo.Sync.Insets.render(this.component.render("headerInsets"),this._headerColumnDivs[b],"padding");
this._headerColumnDivs[b].appendChild(document.createTextNode(this._columnNames[b]));this._headerDiv.appendChild(this._headerColumnDivs[b]);}this._columnDivs[b]=document.createElement("div");this._columnDivs[b].style.cssText="position:absolute;top:0;bottom:0;overflow:hidden;";this._columnDivs[b].style.width=c+"px";this._columnDivs[b].style.left=a+"px";this._listDiv.appendChild(this._columnDivs[b]);a+=c;Core.Web.VirtualPosition.redraw(this._columnDivs[b]);}this._columnsRendered=true;},renderDispose:function(a){Core.Web.Event.removeAll(this._div);this._model.removeUpdateListener(this._updateListenerRef);this._scrollContainer.dispose();this._bounds=null;this._listBounds=null;this._div=null;this._listDiv=null;this._columnDivs=null;this._protoCell=null;this._scrollContainer=null;},renderDisplay:function(){Core.Web.VirtualPosition.redraw(this._div);Core.Web.VirtualPosition.redraw(this._headerDiv);Core.Web.VirtualPosition.redraw(this._containerDiv);Core.Web.VirtualPosition.redraw(this._listDiv);
var b=this._bounds||{};var c=new Core.Web.Measure.Bounds(this._containerDiv);this._bounds=c;var a=this._model.size()*this._cellHeight;this._scrollContainer.setActive(this._bounds.height<a);this._listBounds=new Core.Web.Measure.Bounds(this._listDiv);this._scrollContainer.renderDisplay();if(c.width!=b.width||c.height!=b.height){this._clearContent();this._renderColumns();this._renderRowsFull();}},_renderRowsFull:function(){var b,g,h,c,f,a,i=this.component.get("selection")||{},d=this._model.size();this._renderedPosition=this._position;this._renderedStartIndex=Math.floor(this._position);this._renderedEndIndex=Math.min(d,Math.ceil(this._renderedStartIndex+this._listBounds.height/this._cellHeight));a=document.createElement("div");for(c=this._renderedStartIndex;c<this._renderedEndIndex;++c){b=this._protoCell.cloneNode(false);a.appendChild(b);}var e=0-Math.floor((this._position-Math.floor(this._position))*this._cellHeight);this._model.fetch(this._renderedStartIndex,this._renderedEndIndex);g=[];for(h=0;
h<this._columnDivs.length;++h){f=a.cloneNode(true);g.push(f.firstChild);this._columnDivs[h].appendChild(f);this._columnDivs[h].style.top=e+"px";}for(c=this._renderedStartIndex;c<this._renderedEndIndex&&c<d;++c){this._renderer.render(this.component,this._model.get(c),c,g);if(i[c]){this._renderHighlight(g,c,false);}for(h=0;h<this._columnDivs.length;++h){g[h]=g[h].nextSibling;}}},_renderRowsIncremental:function(c){var l=Math.floor(this._position);var e=Math.min(this._model.size(),Math.ceil(l+this._listBounds.height/this._cellHeight+1));var a,j,b,i,d,h,f,k=this.component.get("selection")||{};var g=0-Math.floor((this._position-Math.floor(this._position))*this._cellHeight);this._renderedPosition=this._position;this._model.fetch(l,e);for(h=0;h<this._columnDivs.length;++h){this._columnDivs[h].style.top=g+"px";}if(c){i=this._renderedEndIndex-e;d=this._renderedStartIndex-l;for(f=0;f<i;++f){for(h=0;h<this._columnDivs.length;++h){a=this._columnDivs[h].firstChild;a.removeChild(a.lastChild);}}for(f=this._renderedStartIndex-1;
f>=l;--f){j=[];for(h=0;h<this._columnDivs.length;++h){a=this._columnDivs[h].firstChild;b=this._protoCell.cloneNode(false);a.insertBefore(b,a.firstChild);j.push(b);}this._renderer.render(this.component,this._model.get(f),f,j);if(k[f]){this._renderHighlight(j,f,false);}}}else{i=l-this._renderedStartIndex;d=e-this._renderedEndIndex;for(f=0;f<i;++f){for(h=0;h<this._columnDivs.length;++h){a=this._columnDivs[h].firstChild;a.removeChild(a.firstChild);}}for(f=this._renderedEndIndex;f<e;++f){j=[];for(h=0;h<this._columnDivs.length;++h){a=this._columnDivs[h].firstChild;b=this._protoCell.cloneNode(false);a.appendChild(b);j.push(b);}this._renderer.render(this.component,this._model.get(f),f,j);if(k[f]){this._renderHighlight(j,f,false);}}}this._renderedStartIndex=l;this._renderedEndIndex=e;},_renderRowsUpdate:function(){if(this._position===this._renderedPosition){return;}var a=Math.abs(this._renderedPosition-this._position)<(0.75*this._listBounds.height/this._cellHeight);if(a){this._renderRowsIncremental(this._position<this._renderedPosition);
}else{this._clearContent();this._renderColumns();this._renderRowsFull();}},renderUpdate:function(c){var a=this._div;var b=a.parentNode;Echo.Render.renderComponentDispose(c,c.parent);b.removeChild(a);this.renderAdd(c,b);return true;},_setPosition:function(a){this._position=a;this._renderRowsUpdate();},_setHighlight:function(b,e){var a=[];for(var d=0;d<this._columnDivs.length;++d){var c=this._getCellDiv(d,b);if(!c){return;}a.push(c);}this._renderHighlight(a,b,e);},_updateListener:function(d){if(d.refresh){Echo.Render.renderComponentDisplay(this.component);this._scrollContainer.setRows(this._model.size());this._clearContent();this._renderColumns();this._renderRowsFull();return;}var a=Math.max(this._renderedStartIndex,d.startIndex),g=Math.min(this._renderedEndIndex,d.endIndex),b,f,h,i,c,j=this.component.get("selection")||{};if(g<=a){return;}i=[];for(h=0;h<this._columnDivs.length;++h){b=this._columnDivs[h].firstChild;c=b.childNodes[a-this._renderedStartIndex];i.push(c);}for(f=a;f<g;++f){for(h=0;
h<this._columnDivs.length;++h){while(i[h].firstChild){i[h].removeChild(i[h].firstChild);}}this._renderer.render(this.component,this._model.get(f),f,i);if(j[f]){this._renderHighlight(i,f,false);}for(h=0;h<this._columnDivs.length;++h){i[h]=i[h].nextSibling;}}}});Extras.Sync.ListViewer.Renderer=Core.extend({$abstract:{render:function(d,b,c,a){},dispose:function(d,b,c,a){}}});Extras.Sync.ListViewer.ColumnRenderer=Core.extend(Extras.Sync.ListViewer.Renderer,{$virtual:{renderColumn:function(d,b,c,a,e,f){a.appendChild(document.createTextNode(e.toString()));}},columnPropertyNames:null,render:function(d,b,c,a){var f,e;if(!b){return;}for(e=0;e<a.length;++e){f=b[(this.columnPropertyNames?this.columnPropertyNames[e]:null)||e];if(f!=null){this.renderColumn(d,b,c,a[e],f,e);}}},dispose:function(d,b,c,a){}});