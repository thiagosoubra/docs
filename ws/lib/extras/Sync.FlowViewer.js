Extras.Sync.FlowViewer=Core.extend(Echo.Render.ComponentSync,{$static:{DOUBLE_CLICK_TIME:500},$load:function(){Echo.Render.registerPeer("Extras.FlowViewer",this);},_position:0,_renderedPosition:0,_columnsRendered:false,$construct:function(){this._updateListenerRef=Core.method(this,this._updateListener);},_clearContent:function(){this._columnsRendered=false;while(this._flowDiv.firstChild){this._flowDiv.removeChild(this._flowDiv.firstChild);}},_createProtoCell:function(){this._protoCell=document.createElement("div");this._protoCell.style.cssText="overflow:hidden;";this._protoCell.style.height=this._cellSize.height+"px";this._protoCell.style.width=this._cellSize.width+"px";},_getIndexFromNode:function(f){var a,g;var c;var e;var d;c=f;while(c&&c.parentNode!==this._flowDiv){c=c.parentNode;}if(!c){return -1;}d=c;a=0;c=d.parentNode.firstChild;while(c){if(c==d){break;}++a;c=c.nextSibling;}if(!c){return -1;}e=d.firstChild;while(f&&f.parentNode!==e){f=f.parentNode;}if(!f){return -1;}c=e.firstChild;
g=0;while(c){if(c===f){var b=(g+this._renderedStartRow)*this._columnCount+a;return b<this._model.size()?b:-1;}c=c.nextSibling;++g;}return -1;},_processClick:function(h,g){if(!this.client||!this.client.verifyInput(this.component)){return;}var c=this._getIndexFromNode(h.target);if(c===-1){return;}var f=new Date().getTime();if(!g&&this._lastClickIndex==c&&f-this._lastClickTime<Extras.Sync.FlowViewer.DOUBLE_CLICK_TIME){this._processDoubleClick(h);return;}if(!g&&h.button===2){g=true;}if(h.ctrlKey||h.metaKey||h.altKey){this._lastClickIndex=-1;this._lastClickTime=0;var d=this.component.get("selection")||{};if(!g&&d[c]){delete d[c];}else{d[c]=true;}this.component.set("selection",null,true);this.component.set("selection",d,true);this._setHighlight(c,true);}else{this._lastClickIndex=c;this._lastClickTime=new Date().getTime();var b=this.component.get("selection")||{};if(!g||!b[c]){d={};d[c]=true;this.component.set("selection",d,true);for(var a in b){if(a!==c){this._setHighlight(a,false);}}this._setHighlight(c,true);
}}},_processContextMenu:function(a){this._processClick(a,true);return true;},_processDoubleClick:function(b){if(!this.client||!this.client.verifyInput(this.component)){return;}var a=this._getIndexFromNode(b.target);if(a!==-1){this.component.doAction(a);}},_processScroll:function(a){this._setPosition(a.row);},renderAdd:function(c,a){this._columnsRendered=false;this._model=this.component.get("model")||new Extras.Viewer.NullModel();this._model.addUpdateListener(this._updateListenerRef);this._renderer=this.component.get("renderer")||new Extras.Sync.FlowViewer.NullRenderer();var b=this._renderer.getCellSize();this._cellSize={width:b.width||100,height:b.height||100};this._createProtoCell();this._div=document.createElement("div");this._div.style.cssText="position:absolute;left:0;top:0;right:0;bottom:0;";this._scrollContainer=new Extras.Sync.Viewer.ScrollContainer(this.client,this.component,this._model.size(),this._cellSize.height);this._scrollContainer.onScroll=Core.method(this,this._processScroll);
this._div.appendChild(this._scrollContainer.rootElement);this._flowDiv=document.createElement("div");this._flowDiv.style.cssText="position:absolute;left:0;top:0;bottom:0;right:0;cursor:pointer;";Echo.Sync.Color.renderFB(this.component,this._flowDiv);Echo.Sync.FillImage.render(this.component.render("backgroundImage"),this._flowDiv);this._scrollContainer.contentElement.appendChild(this._flowDiv);a.appendChild(this._div);Core.Web.Event.add(this._div,"contextmenu",Core.method(this,this._processContextMenu),false);Core.Web.Event.add(this._div,"mouseup",Core.method(this,this._processClick),false);Core.Web.Event.Selection.disable(this._div);},_renderCellsFull:function(){var g,d,a,b,h,c,f,j=this._model.size();var i=this.component.get("selection")||{};this._renderedPosition=this._position;this._renderedStartRow=Math.floor(this._position);this._renderedEndRow=Math.min(this._rowCount,Math.ceil(1+this._renderedStartRow+this._flowBounds.height/this._cellSize.height));var e=0-Math.floor((this._position-Math.floor(this._position))*this._cellSize.height);
a=document.createElement("div");for(d=this._renderedStartRow;d<this._renderedEndRow;++d){b=this._protoCell.cloneNode(false);a.appendChild(b);}h=[];for(g=0;g<this._columnDivs.length;++g){f=a.cloneNode(true);h.push(f.firstChild);this._columnDivs[g].appendChild(f);this._columnDivs[g].style.top=e+"px";}this._model.fetch(this._renderedStartRow*this._columnCount,this._renderedEndRow*this._columnCount);for(d=this._renderedStartRow;d<this._renderedEndRow;++d){for(g=0;g<this._columnCount;++g){c=d*this._columnCount+g;if(c<j){this._renderer.render(this.component,this._model.get(c),c,h[g],{selected:i[c]});}h[g]=h[g].nextSibling;}}},_renderCellsIncremental:function(d){var l=Math.floor(this._position);var e=Math.min(this._rowCount,Math.ceil(l+this._flowBounds.height/this._cellSize.height+1));var i=0-Math.floor((this._position-Math.floor(this._position))*this._cellSize.height);var a,k,b,c,h,g,f;var m=this._model.size();var j=this.component.get("selection")||{};this._renderedPosition=this._position;this._model.fetch(l*this._columnCount,e*this._columnCount);
for(h=0;h<this._columnDivs.length;++h){this._columnDivs[h].style.top=i+"px";Core.Web.VirtualPosition.redraw(this._columnDivs[h]);}if(d){a=this._renderedEndRow-e;k=this._renderedStartRow-l;for(g=0;g<a;++g){for(h=0;h<this._columnDivs.length;++h){b=this._columnDivs[h].firstChild;if(b.lastChild){b.removeChild(b.lastChild);}}}for(g=this._renderedStartRow-1;g>=l;--g){for(h=0;h<this._columnDivs.length;++h){f=g*this._columnCount+h;b=this._columnDivs[h].firstChild;c=this._protoCell.cloneNode(false);b.insertBefore(c,b.firstChild);if(f<m){this._renderer.render(this.component,this._model.get(f),f,c,{selected:j[f]});}}}}else{a=l-this._renderedStartRow;k=e-this._renderedEndRow;for(g=0;g<a;++g){for(h=0;h<this._columnDivs.length;++h){b=this._columnDivs[h].firstChild;if(b.firstChild){b.removeChild(b.firstChild);}}}for(g=this._renderedEndRow;g<e;++g){for(h=0;h<this._columnDivs.length;++h){f=g*this._columnCount+h;b=this._columnDivs[h].firstChild;c=this._protoCell.cloneNode(false);b.appendChild(c);if(f<m){this._renderer.render(this.component,this._model.get(f),f,c,{selected:j[f]});
}}}}this._renderedStartRow=l;this._renderedEndRow=e;},_renderCellsUpdate:function(){if(this._position===this._renderedPosition){return;}var a=Math.abs(this._renderedPosition-this._position)<(0.75*this._flowBounds.height/this._cellSize.height);if(a){this._renderCellsIncremental(this._position<this._renderedPosition);}else{this._clearContent();this._renderColumns();this._renderCellsFull();}},_renderColumns:function(){if(this._columnsRendered){return;}this._columnDivs=[];var a=Math.max(0,Math.floor((this._flowBounds.width-this._columnCount*this._cellSize.width)/2));for(var b=0;b<this._columnCount;++b){this._columnDivs[b]=document.createElement("div");this._columnDivs[b].style.cssText="position:absolute;top:0;bottom:0;overflow:hidden;";this._columnDivs[b].style.width=this._cellSize.width+"px";this._columnDivs[b].style.left=a+"px";this._flowDiv.appendChild(this._columnDivs[b]);a+=this._cellSize.width;Core.Web.VirtualPosition.redraw(this._columnDivs[b]);}this._columnsRendered=true;},renderDisplay:function(){Core.Web.VirtualPosition.redraw(this._div);
Core.Web.VirtualPosition.redraw(this._flowDiv);var c=this._bounds||{};var d=new Core.Web.Measure.Bounds(this._div);this._bounds=d;var b=this._model.size();this._columnCount=Math.max(1,Math.floor((d.width-Core.Web.Measure.SCROLL_WIDTH)/this._cellSize.width));this._rowCount=Math.ceil(b/this._columnCount);var a=b*this._cellSize.height;this._scrollContainer.setActive(this._bounds.height<a);this._scrollContainer.setRows(this._rowCount);this._flowBounds=new Core.Web.Measure.Bounds(this._flowDiv);this._scrollContainer.renderDisplay();if(d.width!=c.width||d.height!=c.height){this._clearContent();this._renderColumns();this._renderCellsFull();}},renderDispose:function(a){this._bounds=null;Core.Web.Event.removeAll(this._div);this._scrollContainer.dispose();this._model.removeUpdateListener(this._updateListenerRef);this._scrollContainer=null;this._flowDiv=null;this._div=null;},renderUpdate:function(c){var a=this._div;var b=a.parentNode;Echo.Render.renderComponentDispose(c,c.parent);b.removeChild(a);
this.renderAdd(c,b);return true;},_setHighlight:function(b,f){if(b<this._renderedStartRow*this._columnCount||b>=this._renderedEndRow*this._columnCount){return;}var e,a,g,d;var c=this.component.get("selection")||{};g=Math.floor(b/this._columnCount);a=b%this._columnCount;e=this._columnDivs[a].firstChild;d=e.childNodes[g-this._renderedStartRow];while(d.firstChild){d.removeChild(d.firstChild);}this._renderer.render(this.component,this._model.get(b),b,d,{selected:c[b]});},_setPosition:function(a){this._position=a;this._renderCellsUpdate();},_updateListener:function(f){if(f.refresh){Echo.Render.renderComponentDisplay(this.component);this._clearContent();this._renderColumns();this._renderCellsFull();return;}var a=Math.max(this._renderedStartRow*this._columnCount,f.startIndex),h=Math.min(this._renderedEndRow*this._columnCount,f.endIndex),b,d,g,j,k,c;if(h<a){return;}var l=this.component.get("selection")||{};for(d=a;d<h;++d){g=Math.floor(d/this._columnCount);j=d%this._columnCount;b=this._columnDivs[j].firstChild;
c=b.childNodes[g-this._renderedStartRow];while(c.firstChild){c.removeChild(c.firstChild);}this._renderer.render(this.component,this._model.get(d),d,c,{selected:l[d]});}}});Extras.Sync.FlowViewer.Renderer=Core.extend({$abstract:{getCellSize:function(){},render:function(d,b,c,a){},dispose:function(d,b,c,a){}}});Extras.Sync.FlowViewer.NullRenderer=Core.extend(Extras.Sync.FlowViewer.Renderer,{getCellSize:function(){return{width:100,height:100};},render:function(d,b,c,a){a.appendChild(document.createTextNode((b||"\u00a0").toString()));},dispose:function(d,b,c,a){}});