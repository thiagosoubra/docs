FileTransfer.Sync={};FileTransfer.Sync.AbstractUploadSelect=Core.extend(Echo.Render.ComponentSync,{$abstract:true,uploadRender:null,_componentListener:null,div:null,progressDisplay:null,urlParameters:null,$construct:function(){this._componentListener=Core.method(this,function(a){switch(a.type){case"uploadCancel":this.uploadRender.cancel();break;case"uploadSend":this.send();break;}});},renderAdd:function(d,b){this.component.addListener("uploadCancel",this._componentListener);this.component.addListener("uploadSend",this._componentListener);this.urlParameters=[];this.urlParameters.push("pid="+this.component.processId);var c=this.component.get("parameters");if(c){for(var a in c){this.urlParameters.push(a+"="+c[a]);}}if(!this.uploadRender){this.uploadRender=new FileTransfer.Sync.DefaultUploadRender();}this.uploadRender.peer=this;this.div=document.createElement("div");this.div.id=this.component.renderId;this.uploadRender.add();b.appendChild(this.div);},renderDisplay:function(){if(this.uploadRender.display){this.uploadRender.display();
}},renderDispose:function(a){this.component.removeListener("uploadCancel",this._componentListener);this.component.removeListener("uploadSend",this._componentListener);if(this.progressDisplay){this.progressDisplay.dispose();}this.component.cancel();this.uploadRender.dispose(this.div);this.uploadRender.disposed=true;this.div=null;this.uploadRender.peer=null;this.uploadRender=null;},renderUpdate:function(c){var a=this.div;var b=a.parentNode;Echo.Render.renderComponentDispose(c,c.parent);b.removeChild(a);this.renderAdd(c,b);return true;},send:function(){this.progressDisplay=FileTransfer.Sync.ProgressDisplay.instantiate(this.component);this.progressDisplay.create(this.div);this.uploadRender.send();}});FileTransfer.Sync.UploadRender=Core.extend({peer:null,disposed:false,$abstract:{add:function(){},cancel:function(){},dispose:function(){},send:function(){}},$virtual:{display:null}});FileTransfer.Sync.DefaultUploadRender=Core.extend(FileTransfer.Sync.UploadRender,{_fileInput:null,_form:null,_monitor:null,_progressFile:null,add:function(){if(Core.Web.Env.BROWSER_INTERNET_EXPLORER&&Core.Web.Env.BROWSER_VERSION_MAJOR<9){var c="<iframe "+'name="'+this.peer.component.renderId+'_target" '+'src="'+this.peer.client.getResourceUrl("Echo","resource/Blank.html")+'" '+'scrolling="no" style="display:none;" frameBorder="0" width="100" height="30"></iframe>';
this.peer.div.innerHTML=c;this._form=document.createElement('<form enctype="multipart/form-data"/>');}else{var a=document.createElement("iframe");a.style.display="none";a.src=this.peer.client.getResourceUrl("Echo","resource/Blank.html");a.id=a.name=this.peer.component.renderId+"_target";a.scrolling="no";a.frameBorder=0;a.width=100;a.height=30;this.peer.div.appendChild(a);this._form=document.createElement("form");this._form.enctype="multipart/form-data";}this._form.target=this.peer.component.renderId+"_target";var b=this.peer.component.get("receiver");b+=(b.indexOf("?")==-1?"?":"&")+this.peer.urlParameters.join("&");this._form.action=b;this._form.method="POST";this._form.style.padding=0;this._form.style.margin=0;this.peer.div.appendChild(this._form);this._fileInput=document.createElement("input");this._fileInput.type="file";this._fileInput.name=this.peer.component.renderId;this._form.appendChild(this._fileInput);Core.Web.Event.add(this._fileInput,"change",Core.method(this,function(){if(!this._fileInput.value){return false;
}this.peer.component.ready();}),false);},cancel:function(){this._monitor.cancel=true;},dispose:function(){Core.Web.Event.removeAll(this._fileInput);this._form=null;this._fileInput=null;},_progress:function(a){if(this.disposed){return false;}else{if(a.complete){this.peer.progressDisplay.complete();this.peer.component.complete();return false;}else{if(a.progress!=null){if(!this.peer.progressDisplay.initialized){this._progressFile=new FileTransfer.Sync.ProgressDisplay.File(a.fileName,a.size);this.peer.progressDisplay.add(this._progressFile);this.peer.progressDisplay.init();}this._progressFile.progress=a.progress;this.peer.progressDisplay.update();return true;}else{if(a.unknownPid){if(!this._started){this._start();}return true;}}}}},send:function(){this._fileInput.style.display="none";var a=this.peer.component.get("monitor")||this.peer.component.get("receiver");a+=(a.indexOf("?")==-1?"?":"&")+this.peer.urlParameters.join("&");this._monitor=new FileTransfer.Sync.Monitor(a,Core.method(this,this._progress));
this._monitor.start();},_start:function(){this._started=true;this._form.submit();}});FileTransfer.Sync.UploadSelect=Core.extend(FileTransfer.Sync.AbstractUploadSelect,{$load:function(){Echo.Render.registerPeer("FileTransfer.UploadSelect",this);}});FileTransfer.Sync.Monitor=Core.extend(Core.Web.Scheduler.Runnable,{timeInterval:500,_monitorUrl:null,cancel:false,_onProgress:null,$construct:function(a,b){this._monitorUrl=a;this._onProgress=b;},start:function(){Core.Web.Scheduler.add(this);},_processResponse:function(g){var a={},h,c,f,b;if(g.source.getStatus()!=200){return;}c=g.source.getResponseXml().documentElement.getElementsByTagName("s")[0];f=c.getAttribute("p");if(f){var d=f.split("/");a.progress=parseInt(d[0],10);a.size=parseInt(d[1],10);}else{b=c.getAttribute("v");switch(b){case"complete":a.complete=true;break;case"cancel":a.cancel=true;break;case"unknownpid":a.unknownPid=true;break;}}if(this._onProgress(a)){Core.Web.Scheduler.add(this);}},run:function(){var a=this._monitorUrl;if(this.cancel){a+=(a.indexOf("?")==-1?"?":"&")+"command=cancel";
}var b=new Core.Web.HttpConnection(a,"GET");b.addResponseListener(Core.method(this,this._processResponse));b.connect();}});FileTransfer.Sync.ProgressDisplay=Core.extend({$static:{File:Core.extend({size:null,name:null,progress:null,$construct:function(a,b){this._id=FileTransfer.Sync.ProgressDisplay.File.nextId++;this.name=a;this.size=b;this.progress=0;}}),component:null,implementation:null,instantiate:function(b){var a=new this.implementation();a.component=b;return a;}},files:null,totalSize:null,initialized:false,$abstract:{complete:function(){},create:function(a){},dispose:function(){},update:function(){}},add:function(a){if(this.initialized){throw new Error("Illegal attempt to add files to an initialized progress display.");}if(!this.files){this.files=[];}this.files.push(a);},getTotalProgress:function(){var a=0;for(var b=0;b<this.files.length;++b){a+=this.files[b].progress;}return a;},init:function(){if(this.intialized){throw new Error("Illegal attempt to initialize a previously initialized progress display.");
}this.initialized=true;this.totalSize=0;for(var a=0;a<this.files.length;++a){this.totalSize+=this.files[a].size;}}});FileTransfer.Sync.DefaultProgressDisplay=Core.extend(FileTransfer.Sync.ProgressDisplay,{$load:function(){FileTransfer.Sync.ProgressDisplay.implementation=this;},$static:{DEFAULT_STYLE:{border:"1px outset #dfdfdf",background:"#dfdfdf",foreground:"#000000",barBorder:"1px outset #cfcfff",barBackground:"#cfcfff",barForeground:"#000000"}},style:null,_div:null,_barDiv:null,_percentComplete:null,complete:function(){this._percentComplete=100;this._redraw();},create:function(a){var b=this.style||{},c=FileTransfer.Sync.DefaultProgressDisplay.DEFAULT_STYLE;this._div=document.createElement("div");this._div.style.cssText="position:relative;overflow:hidden;text-align:center;";Echo.Sync.Border.render(b.border||c.border,this._div);Echo.Sync.Color.render(b.background||c.background,this._div,"backgroundColor");Echo.Sync.Color.render(b.foreground||c.foreground,this._div,"color");if(Core.Web.Env.QUIRK_IE_HAS_LAYOUT){this._div.style.zoom=1;
}a.appendChild(this._div);this._barDiv=document.createElement("div");this._barDiv.style.cssText="z-index:1;margin:-1px;position:absolute;top:0;bottom:0;left:0;width:0;";Echo.Sync.Border.render(b.barBorder||c.barBorder,this._barDiv);Echo.Sync.Color.render(b.barBackground||c.barBackground,this._barDiv,"backgroundColor");Echo.Sync.Color.render(b.barForeground||c.barForeground,this._barDiv,"color");this._div.appendChild(this._barDiv);this._textDiv=document.createElement("div");this._textDiv.style.cssText="z-index:2;position:relative;";this._div.appendChild(this._textDiv);this._text=document.createTextNode("\u00a0");this._textDiv.appendChild(this._text);},dispose:function(){this._barDiv=null;this._div=null;},_redraw:function(){this._barDiv.style.width=this._percentComplete+"%";this._text.nodeValue=this._percentComplete+"%";},update:function(){this._percentComplete=Math.round(100*(this.getTotalProgress()/this.totalSize));this._redraw();}});