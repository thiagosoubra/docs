FileTransfer.Sync.MultipleUploadSelect=Core.extend(FileTransfer.Sync.UploadSelect,{$load:function(){Echo.Render.registerPeer("FileTransfer.MultipleUploadSelect",this);if(Core.Web.Env.ENGINE_MSHTML){try{this.flashAvailable=!!(new ActiveXObject("ShockwaveFlash.ShockwaveFlash.9"));}catch(d){}}else{if(navigator.plugins){for(var c=0;c<navigator.plugins.length;++c){if(/flash/gi.test(navigator.plugins[c].name)){var b=/[0-9]+/g.exec(navigator.plugins[c].description);if(b){var a=parseInt(b[0],10);this.flashAvailable=a>=9;}}}}}},$static:{flashAvailable:false},renderAdd:function(b,a){if(FileTransfer.Sync.MultipleUploadSelect.flashAvailable&&!this.uploadRender){this.uploadRender=new FileTransfer.Sync.MultipleUploadSelect.SWFUploadRender();}FileTransfer.Sync.UploadSelect.prototype.renderAdd.call(this,b,a);}});FileTransfer.Sync.MultipleUploadSelect.SWFUploadRender=Core.extend(FileTransfer.Sync.UploadRender,{_buttonDiv:null,_swfUploadDiv:null,_swfUpload:null,_progressDisplay:null,_progressFileMap:null,_canceled:false,add:function(){this.peer.div.style.cssText="position:relative;overflow:hidden;width:"+Echo.Sync.Extent.toPixels("20em")+"px;";
if(Core.Web.Env.QUIRK_IE_HAS_LAYOUT){this.peer.div.style.zoom=1;}this._buttonDiv=document.createElement("div");Echo.Sync.renderComponentDefaults(this.peer.component,this._buttonDiv);Echo.Sync.Border.render(this.peer.component.render("border"),this._buttonDiv);Echo.Sync.Insets.render(this.peer.component.render("insets"),this._buttonDiv,"padding");this._buttonDiv.appendChild(document.createTextNode(this.peer.component.render("text","Upload")));this.peer.div.appendChild(this._buttonDiv);},cancel:function(){this._canceled=true;this._swfUpload.cancelUpload();},display:function(){var a=new Core.Web.Measure.Bounds(this.peer.div,{flags:Core.Web.Measure.Bounds.FLAG_MEASURE_DIMENSION});if(!this._swfUpload){this._renderUploadControl(a);}},dispose:function(){this._progressFileMap=null;Core.Debug.consoleWrite(this._swfUpload.destroy());this._swfUploadDiv=null;},_processNextUpload:function(){if(this._canceled){return;}var a=this._swfUpload.getStats();if(a.in_progress){throw new Error("Attempt to initiate upload while upload in progress.");
}if(a.files_queued){this._swfUpload.startUpload();}else{this.peer.component.complete();}},_processDialogComplete:function(a,c,b){if(this._swfUpload.getStats().files_queued){this.peer.component.ready();}},_processUploadStart:function(a){Core.Debug.consoleWrite("Upload started:"+a);},_processUploadComplete:function(a){this._processNextUpload();Core.Debug.consoleWrite("complete:"+Core.Debug.toString(arguments));Core.Debug.consoleWrite(this._swfUpload.startUpload());},_processProgress:function(c,a,b){var d=this._progressFileMap[c.id];d.progress=a;this.peer.progressDisplay.update();},_renderUploadControl:function(c){this._swfUploadDiv=document.createElement("div");this._swfUploadDiv.style.cssText="position:absolute;z-index:10000;top:0;left:0;width:100%;height:100%;";this.peer.div.appendChild(this._swfUploadDiv);var b=document.createElement("span");this._swfUploadDiv.appendChild(b);var a=this.peer.component.get("receiver");a+=(a.indexOf("?")==-1?"?":"&")+this.peer.urlParameters.join("&");this._swfUpload=new SWFUpload({button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_placeholder:b,button_width:c.width,button_height:c.height,button_text:"",preserve_relative_urls:true,upload_url:a,flash_url:this.peer.client.getResourceUrl("FileTransfer","swfupload.swf"),file_size_limit:this.peer.component.render("maximumSize",20*1024*1024),upload_start_handler:Core.method(this,this._processUploadStart),upload_success_handler:Core.method(this,this._processUploadComplete),upload_progress_handler:Core.method(this,this._processProgress),file_dialog_complete_handler:Core.method(this,this._processDialogComplete)});
},send:function(){this._swfUpload.setButtonDimensions(0,0);this.peer.div.style.width="";this._buttonDiv.style.display="none";this._progressFileMap={};var d=this._swfUpload.getStats().files_queued;for(var b=0;b<d;++b){var a=this._swfUpload.getFile(b);var c=new FileTransfer.Sync.ProgressDisplay.File(a.name,a.size);this._progressFileMap[a.id]=c;this.peer.progressDisplay.add(c);}this.peer.progressDisplay.init();this._processNextUpload();}});