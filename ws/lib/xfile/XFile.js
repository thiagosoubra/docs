XFile=Core.extend({$static:{SUPPORT:false,FOLDER_SUPPORT:false},$load:function(){this.SUPPORT=!!(window.File&&window.FileReader&&window.FileList&&window.Blob);this.FOLDER_SUPPORT=this.SUPPORT&&Core.Web.Env.BROWSER_CHROME;},_rootElement:null,_client:null,_fileInput:null,_fileInputChangeRef:null,_activeUpload:null,_pendingUploads:null,_completedUploads:null,uploads:null,_aborted:false,_processDragOverRef:null,_processDragOutRef:null,_processDropRef:null,_sizeCalculated:false,_completedUploadDataSize:0,_completedUploadItemCount:0,_totalDataSize:0,_totalItemCount:0,_transferRate:null,$construct:function(a){if(!XFile.SUPPORT){return;}this._maskRemoveRunnable=new Core.Web.Scheduler.MethodRunnable(Core.method(this,this._maskRemoveAction),200);this._rootElement=a;this._processDropRef=Core.method(this,this._processDrop);this._processDragOverRef=Core.method(this,this._processDragOver);this._processDragOutRef=Core.method(this,this._processDragOut);this._processFileInputChangeRef=Core.method(this,this._processFileInputChange);
Core.Web.DOM.addEventListener(this._rootElement,"dragover",this._processDragOverRef,true);Core.Web.DOM.addEventListener(this._rootElement,"dragout",this._processDragOutRef,true);Core.Web.DOM.addEventListener(this._rootElement,"dragleave",this._processDragOutRef,true);Core.Web.DOM.addEventListener(this._rootElement,"drop",this._processDropRef,true);this.reset();},_addUpload:function(b){if(!this._client||!this._client.isReady()){return;}this._sizeCalculated=false;var a=new XFile.Upload(this,this._client);this._pendingUploads.push(a);this.uploads.push(a);a.processDataTransfer(b);},_calculateSize:function(){var a;this._totalDataSize=0;this._totalItemCount=0;this._completedUploadDataSize=0;this._completedUploadItemCount=0;if(this._activeUpload){this._totalDataSize+=this._activeUpload.dataSize;this._totalItemCount+=this._activeUpload.itemCount;}for(a=0;a<this._pendingUploads.length;++a){this._totalDataSize+=this._pendingUploads[a].dataSize;this._totalItemCount+=this._pendingUploads[a].itemCount;
}for(a=0;a<this._completedUploads.length;++a){this._totalDataSize+=this._completedUploads[a].dataSize;this._totalItemCount+=this._completedUploads[a].itemCount;this._completedUploadDataSize+=this._completedUploads[a].dataSize;this._completedUploadItemCount+=this._completedUploads[a].itemCount;}this._sizeCalculated=true;},dispose:function(){if(!XFile.SUPPORT){return;}if(this._fileInput){this._fileInput.parent.removeChild(this._fileInput);Core.Web.DOM.removeEventListener(this._fileInput,"change",this._processFileInputChangeRef,false);this._fileInput=null;}Core.Web.DOM.removeEventListener(this._rootElement,"dragover",this._processDragOverRef,true);Core.Web.DOM.removeEventListener(this._rootElement,"dragout",this._processDragOutRef,true);Core.Web.DOM.removeEventListener(this._rootElement,"dragleave",this._processDragOutRef,true);Core.Web.DOM.removeEventListener(this._rootElement,"drop",this._processDropRef,true);this._rootElement=null;},abortAll:function(){if(!XFile.SUPPORT){return;}this._aborted=true;
if(this._activeUpload){this._activeUpload.abort();}this.reset();},choose:function(a){if(!XFile.SUPPORT){return;}if(!this._client||!this._client.isReady()){return;}if(!this._fileInput){this._fileInput=document.createElement("input");this._fileInput.setAttribute("type","file");this._fileInput.setAttribute("multiple","multiple");this._fileInput.style.visibility="hidden";this._rootElement.appendChild(this._fileInput);Core.Web.DOM.addEventListener(this._fileInput,"change",this._processFileInputChangeRef,false);}if(a){this._fileInput.setAttribute("directory","directory");this._fileInput.setAttribute("webkitdirectory","webkitdirectory");}else{this._fileInput.removeAttribute("directory");this._fileInput.removeAttribute("webkitdirectory");}this._fileInput.click();},_maskCreate:function(){Core.Web.Scheduler.remove(this._maskRemoveRunnable);if(this._maskDiv){return;}this._maskDiv=document.createElement("div");this._maskDiv.style.cssText="position:absolute;opacity:0.5;z-index:10000;top:0;left:0;bottom:0;right:0;";
var a=document.createElement("div");a.style.cssText="position:absolute;top:0;left:0;bottom:0;right:0;margin:10px;";if(this._client){this._maskDiv.style.backgroundColor="#afafaf";a.style.border="5px dashed #ffffff";}else{this._maskDiv.style.backgroundColor="#5f0f0f";}this._maskDiv.appendChild(a);this._rootElement.appendChild(this._maskDiv);Core.Web.Scheduler.remove(this._maskRemoveRunnable);},_maskRemove:function(){if(!this._maskDiv){return;}Core.Web.Scheduler.remove(this._maskRemoveRunnable);Core.Web.Scheduler.add(this._maskRemoveRunnable);},_maskRemoveAction:function(){if(!this._maskDiv){return;}this._maskDiv.parentNode.removeChild(this._maskDiv);this._maskDiv=null;},_notifyProgress:function(c){if(!this._onProgressListener){return;}if(!this._sizeCalculated){this._calculateSize();}var e=this._activeUpload||this._pendingUploads.length>0;var g=this._completedUploadItemCount;var f=this._completedUploadDataSize;if(c){g+=c.sentItemCount;f+=c.sentDataSize+c.sentCurrentDataSize;}var d=g+(e?1:0);
this._transferRate.setTransferredBytes(f);var a=this._transferRate.getTransferRate();var b=this._transferRate.getTimeRemaining(this._totalDataSize);this._onProgressListener({uploads:this.uploads,uploading:this._activeUpload||this._pendingUploads.length>0,activeUpload:this._activeUpload,totalDataSize:this._totalDataSize,totalItemCount:this._totalItemCount,sentDataSize:f,sentItemCount:g,currentItemIndex:d,transferRate:a,timeRemaining:b});},onUploadComplete:function(a){if(a.upload!=this._activeUpload){return;}this._completedUploads.push(this._activeUpload);this._completedUploadDataSize+=this._activeUpload.dataSize;this._completedUploadItemCount+=this._activeUpload.itemCount;this._activeUpload=null;this._processNextUpload();this._notifyProgress();},onUploadProgress:function(a){this._notifyProgress(a);},onUploadReady:function(a){this._processNextUpload();},_processDragOver:function(a){Core.Web.dragInProgress=true;Core.Web.DOM.preventEventDefault(a);a.dataTransfer.dropEffect="copy";this._maskCreate();
},_processDragOut:function(a){Core.Web.dragInProgress=false;Core.Web.DOM.preventEventDefault(a);this._maskRemove();},_processDrop:function(a){Core.Web.dragInProgress=false;Core.Web.DOM.preventEventDefault(a);this._addUpload(a.dataTransfer);this._maskRemoveAction();},_processFileInputChange:function(a){if(!this._client||!this._client.isReady()){return;}this._addUpload(this._fileInput);},_processNextUpload:function(){if(this._aborted){return;}if(this._activeUpload){return;}if(this._pendingUploads.length===0){return false;}this._activeUpload=this._pendingUploads.shift();this._activeUpload.beginProcessing();},reset:function(){if(!XFile.SUPPORT){return;}this._transferRate=new XFile.TransferRate();this._sizeCalculated=false;this._completedUploads=[];this._activeUpload=null;this._pendingUploads=[];this.uploads=[];this._aborted=false;},setClient:function(a){if(!XFile.SUPPORT){return;}this._client=a;},setProgressListener:function(a){if(!XFile.SUPPORT){return;}this._onProgressListener=a;}});XFile.Client=Core.extend({activeUpload:null,$abstract:{getUploadUrl:function(a){},isReady:function(a){},onUploadAbort:function(a){},onUploadInit:function(a){},onUploadItemComplete:function(a){},onUploadComplete:function(a){},}});
XFile.Descriptor=Core.extend({$static:{_nextId:0},id:-1,data:null,file:null,path:null,createTime:0,uploadedSize:0,fileSize:-1,$construct:function(b,a){this.id=++XFile.Descriptor._nextId;this.file=a;this.fileSize=a.size;this.path=b;this.data={};this.createTime=new Date().getTime();}});XFile.Upload=Core.extend({$static:{_nextId:0},id:-1,_activeRequest:null,aborted:false,completed:false,_sentItemCount:0,_sentDataSize:0,itemCount:0,dataSize:0,_pendingReads:0,descriptors:null,_activeDescriptor:null,_pendingDescriptors:null,_processedDescriptors:null,_xfile:null,_client:null,data:null,$construct:function(b,a){this.id=++XFile.Upload._nextId;this.descriptors=[];this._pendingDescriptors=[];this._processedDescriptors=[];this._client=a;this._xfile=b;this.data={};},beginProcessing:function(){if(this._processingStarted){return;}this._processingStarted=true;this._processNextDescriptor();},abort:function(){if(this.aborted){return;}this.aborted=true;var a=this._activeRequest;if(a){a.abort();}this._client.onUploadAbort({upload:this,items:this.descriptors,data:this.data});
},_addItem:function(c,a){var b=new XFile.Descriptor(c,a);this.descriptors.push(b);this._pendingDescriptors.push(b);},_composePath:function(b,a){if(b==null){return this._trimSlashes(a);}return this._trimSlashes(b)+"/"+this._trimSlashes(a);},_notifyReady:function(){this._xfile.onUploadReady({upload:this});},doInit:function(){this._client.onUploadInit({upload:this,items:this.descriptors,data:this.data});},processDataTransfer:function(a){this.doInit();if(a.items){this._processItems(a);}else{if(a.files){this._processFiles(a);}else{alert("Not supported.");}}},_processFiles:function(b){for(var a=0;a<b.files.length;++a){if(b.files[a].size){this.dataSize+=b.files[a].size;}this.itemCount++;this._addItem(b.files[a].name,b.files[a]);}this._notifyReady();},_processItems:function(e){var d=[];var a=e.items;for(var b=0;b<a.length;++b){var c;if(a[b].getAsEntry){c=a[b].getAsEntry();}else{if(a[b].webkitGetAsEntry){c=a[b].webkitGetAsEntry();}else{continue;}}if(c){d.push(c);}}this._pendingReads=1;this._readEntries(null,d);
},_trimSlashes:function(a){if(a==null){return"";}if(a.length>0&&a.charAt(0)=="/"){a=a.substring(1);}if(a.length>0&&a.charAt(a.length-1)=="/"){a=a.substring(0,a.length-1);}return a;},_readEntries:function(c,a){for(var b=0;b<a.length;++b){this._readEntry(c,a[b]);}--this._pendingReads;if(this._pendingReads===0){this._notifyReady();}},_readEntry:function(d,b){var c=this._composePath(d,b.name);if(b.isDirectory){++this._pendingReads;var a=b.createReader();a.readEntries(Core.method(this,function(e){this._readEntries(c,e);}));}else{if(b.isFile){++this._pendingReads;b.file(Core.method(this,function(e){this._readFile(c,e);}));}}},_readFile:function(b,a){if(a.size){this.dataSize+=parseInt(a.size,10);this.itemCount++;}this._addItem(b,a);--this._pendingReads;if(this._pendingReads===0){this._notifyReady();}},_processNextDescriptor:function(){if(this.aborted){return;}var a=this._pendingDescriptors.shift();if(a==null){if(!this.aborted){this.completed=true;var b={upload:this,data:this.data,items:this._processedDescriptors};
this._client.onUploadComplete(b);this._xfile.onUploadComplete(b);}return;}this._processedDescriptors.push(a);this._sendDescriptor(a);},_onProgress:function(a){if(this._activeDescriptor!=null){this._activeDescriptor.uploadedSize=a.loaded;}this._xfile.onUploadProgress({upload:this,totalDataSize:this.dataSize,totalItemCount:this.itemCount,sentDataSize:this._sentDataSize,sentItemCount:this._sentItemCount,sentCurrentDataSize:a.loaded,totalCurrentDataSize:a.total,currentItemTotal:a.total});},_sendDescriptor:function(b){this._activeDescriptor=b;var c=new XMLHttpRequest();var a=this;c.onreadystatechange=Core.method(this,function(g){if(c.readyState===4){this._activeRequest=null;++this._sentItemCount;var f=b.file.size;b.uploadedSize=f;if(f){this._sentDataSize+=f;}var d={upload:this,data:this.data,item:b,request:c};this._client.onUploadItemComplete(d);a._processNextDescriptor();}});c.open("POST",this._client.getUploadUrl(b),true);c.setRequestHeader("Cache-Control","no-cache");c.setRequestHeader("Content-Type","application/octet-stream");
c.setRequestHeader("Content-Disposition",'attachment; filename="'+b.file.name+'"');if(c.upload){c.upload.addEventListener("progress",Core.method(this,this._onProgress),false);}c.send(b.file);this._activeRequest=c;}});XFile.TransferRate=Core.extend({_timeIntervalPerBucket:500,_lastBucketIndex:0,_buckets:null,_transferRate:-1,_transferredBytes:0,_lastTransferredBytes:0,$construct:function(){this._buckets=new Array(10);for(var a=0;a<this._buckets.length;++a){this._buckets[a]=-1;}},getTimeRemaining:function(b){if(this._transferRate===-1){this.getTransferRate();}if(this._transferRate===0){return -1;}var a=Math.max(0,(b-this._transferredBytes)/this._transferRate);if(a>86400){return -1;}return a;},getTransferRate:function(){var c=0;var a=0;for(var b=0;b<this._buckets.length;++b){if(this._buckets[b]==-1){continue;}c+=this._buckets[b];++a;}if(a===0){return 0;}this._transferRate=Math.max(0,c/(a*this._timeIntervalPerBucket/1000));return this._transferRate;},setTransferredBytes:function(b){this._transferredBytes=b;
var c=Math.max(0,b-this._lastTransferredBytes);if(c>0){this._lastTransferredBytes=b;}var d=new Date().getTime();var a=Math.round(d/this._timeIntervalPerBucket)%this._buckets.length;if(a!=this._lastBucketIndex){while(this._lastBucketIndex!=a){this._lastBucketIndex=(this._lastBucketIndex+1)%this._buckets.length;this._buckets[this._lastBucketIndex]=0;}}this._buckets[a]+=c;}});